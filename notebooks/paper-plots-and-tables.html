

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Render paper plots and tables &mdash; folktexts 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../_static/sg_gallery.css?v=d2d258e8" />
      <link rel="stylesheet" type="text/css" href="../_static/nbsphinx-code-cells.css?v=2aa19091" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=01f34227"></script>
      <script src="../_static/doctools.js?v=9a2dae69"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../_static/copybutton.js?v=f281be69"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
      <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      <script src="../_static/custom.js?v=882eb7ae"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Evaluate model calibration using folktexts" href="minimal-example_web-API-model.html" />
    <link rel="prev" title="Run folktexts benchmark with a custom ACS task" href="custom-acs-task-example.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            folktexts
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../readme.html">Readme file</a></li>
<li class="toctree-l1"><a class="reference internal" href="../source/modules.html">API reference</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../notebooks.html">Example notebooks</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="minimal-example.html">Evaluate model calibration using folktexts</a></li>
<li class="toctree-l2"><a class="reference internal" href="detailed-example.html">Example: Run ACS benchmark task</a></li>
<li class="toctree-l2"><a class="reference internal" href="custom-dataset-example.html">Run <code class="docutils literal notranslate"><span class="pre">folktexts</span></code> benchmark with a different data source</a></li>
<li class="toctree-l2"><a class="reference internal" href="custom-acs-task-example.html">Run <code class="docutils literal notranslate"><span class="pre">folktexts</span></code> benchmark with a custom ACS task</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Render paper plots and tables</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Run-baseline-ML-classifiers-on-the-benchmark-ACS-tasks">Run baseline ML classifiers on the benchmark ACS tasks</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Prepare-results-table-for-each-task">Prepare results table for each task</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Output-latex-results-tables---colored!">Output latex results tables - colored!</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Render-paper-plots">Render paper plots</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#1st-page-illustrative-plot">1st page illustrative plot</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Score-distributions-for-base/instruct-pairs">Score distributions for base/instruct pairs</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#Calibration-curves">Calibration curves</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Calibration-per-sub-group">Calibration per sub-group</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Score-distribution-per-sub-group">Score distribution per sub-group</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Compute-mean-under-/over-estimation-of-risk-score">Compute mean under-/over-estimation of risk score</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Compute-risk-score-fairness-per-sub-group">Compute risk score fairness per sub-group</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Plots-comparing-different-prompting-schemes">Plots comparing different prompting schemes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Scatter-plot-of-ECE-vs-AUC-for-a-few-models-(before-and-after-numeric-prompting)">Scatter plot of ECE vs AUC for a few models (before and after numeric prompting)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="minimal-example_web-API-model.html">Evaluate model calibration using folktexts</a></li>
<li class="toctree-l2"><a class="reference internal" href="parse-acs-results.html">Fetch and parse ACS benchmark results under a given directory</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">folktexts</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../notebooks.html">Notebooks Gallery</a></li>
      <li class="breadcrumb-item active">Render paper plots and tables</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/notebooks/paper-plots-and-tables.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="Render-paper-plots-and-tables">
<h1>Render paper plots and tables<a class="headerlink" href="#Render-paper-plots-and-tables" title="Link to this heading"></a></h1>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm.auto</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
</pre></div>
</div>
</div>
<p><strong>Note:</strong> <em>Change</em> the following path to the aggregated results file in your local system (can be obtained using the <code class="docutils literal notranslate"><span class="pre">parse-acs-results.ipynb</span></code> notebook).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ACS_AGG_RESULTS_PATH</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;../results&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;aggregated-results.2024-08.csv&quot;</span>
<span class="n">ACS_AGG_RESULTS_PATH</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">ACS_AGG_RESULTS_PATH</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">ACS_AGG_RESULTS_PATH</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">results_df</span><span class="o">.</span><span class="n">shape</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">results_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
results_df.shape=(210, 64)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>accuracy</th>
      <th>accuracy_diff</th>
      <th>accuracy_ratio</th>
      <th>balanced_accuracy</th>
      <th>balanced_accuracy_diff</th>
      <th>balanced_accuracy_ratio</th>
      <th>brier_score_loss</th>
      <th>ece</th>
      <th>ece_quantile</th>
      <th>equalized_odds_diff</th>
      <th>...</th>
      <th>name</th>
      <th>is_inst</th>
      <th>num_features</th>
      <th>uses_all_features</th>
      <th>fit_thresh_on_100</th>
      <th>fit_thresh_accuracy</th>
      <th>optimal_thresh</th>
      <th>optimal_thresh_accuracy</th>
      <th>score_stdev</th>
      <th>score_mean</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>penai/gpt-4o-mini__ACSTravelTime__-1__Num</th>
      <td>0.570906</td>
      <td>0.315286</td>
      <td>0.624340</td>
      <td>0.553706</td>
      <td>0.070915</td>
      <td>0.876372</td>
      <td>0.267584</td>
      <td>0.149517</td>
      <td>NaN</td>
      <td>0.382569</td>
      <td>...</td>
      <td>GPT 4o mini (it)</td>
      <td>True</td>
      <td>-1</td>
      <td>True</td>
      <td>0.250000</td>
      <td>0.510013</td>
      <td>0.450000</td>
      <td>0.570968</td>
      <td>0.223652</td>
      <td>0.384149</td>
    </tr>
    <tr>
      <th>penai/gpt-4o-mini__ACSTravelTime__-1__QA</th>
      <td>0.551154</td>
      <td>0.119294</td>
      <td>0.812222</td>
      <td>0.588927</td>
      <td>0.113947</td>
      <td>0.823835</td>
      <td>0.404025</td>
      <td>0.393327</td>
      <td>0.393301</td>
      <td>0.274655</td>
      <td>...</td>
      <td>GPT 4o mini (it)</td>
      <td>True</td>
      <td>-1</td>
      <td>True</td>
      <td>0.998499</td>
      <td>0.602202</td>
      <td>0.970688</td>
      <td>0.593339</td>
      <td>0.365205</td>
      <td>0.772858</td>
    </tr>
  </tbody>
</table>
<p>2 rows × 64 columns</p>
</div></div>
</div>
<p>Remove <code class="docutils literal notranslate"><span class="pre">gemma-2-*</span></code> results (need to investigate why results are so poor):</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results_df</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="n">id_</span> <span class="k">for</span> <span class="n">id_</span> <span class="ow">in</span> <span class="n">results_df</span><span class="o">.</span><span class="n">index</span> <span class="k">if</span> <span class="s2">&quot;gemma-2-&quot;</span> <span class="ow">in</span> <span class="n">id_</span><span class="o">.</span><span class="n">lower</span><span class="p">()])</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">results_df</span><span class="o">.</span><span class="n">shape</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
results_df.shape=(170, 64)
</pre></div></div>
</div>
<section id="Run-baseline-ML-classifiers-on-the-benchmark-ACS-tasks">
<h2>Run baseline ML classifiers on the benchmark ACS tasks<a class="headerlink" href="#Run-baseline-ML-classifiers-on-the-benchmark-ACS-tasks" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">DATA_DIR</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;/fast/groups/sf&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;data&quot;</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ALL_TASKS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;ACSIncome&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ACSMobility&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ACSEmployment&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ACSTravelTime&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ACSPublicCoverage&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">model_col</span> <span class="o">=</span> <span class="s2">&quot;config_model_name&quot;</span>
<span class="n">task_col</span> <span class="o">=</span> <span class="s2">&quot;config_task_name&quot;</span>
<span class="n">numeric_prompt_col</span> <span class="o">=</span> <span class="s2">&quot;config_numeric_risk_prompting&quot;</span>
</pre></div>
</div>
</div>
<p>List all baseline classifiers here:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.ensemble</span><span class="w"> </span><span class="kn">import</span> <span class="n">HistGradientBoostingClassifier</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">xgboost</span><span class="w"> </span><span class="kn">import</span> <span class="n">XGBClassifier</span>    <span class="c1"># NOTE: requires `pip install xgboost`</span>

<span class="n">baselines</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;LR&quot;</span><span class="p">:</span> <span class="n">LogisticRegression</span><span class="p">(),</span>
    <span class="s2">&quot;GBM&quot;</span><span class="p">:</span> <span class="n">HistGradientBoostingClassifier</span><span class="p">(),</span>
    <span class="s2">&quot;XGBoost&quot;</span><span class="p">:</span> <span class="n">XGBClassifier</span><span class="p">(),</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">folktexts.acs.acs_dataset</span><span class="w"> </span><span class="kn">import</span> <span class="n">ACSDataset</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">folktexts.evaluation</span><span class="w"> </span><span class="kn">import</span> <span class="n">evaluate_predictions</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">defaultdict</span>

<span class="k">def</span><span class="w"> </span><span class="nf">fit_and_eval</span><span class="p">(</span>
    <span class="n">clf</span><span class="p">,</span>
    <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span>
    <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">s_test</span><span class="p">,</span>
    <span class="n">fillna</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">save_scores_df_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fit and evaluate a given classifier on the given data.&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_test</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">s_test</span><span class="p">)</span>

    <span class="n">train_nan_count</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">fillna</span> <span class="ow">and</span> <span class="n">train_nan_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Fill NaNs with value=-1</span>
        <span class="n">X_train</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;columns&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">X_test</span> <span class="o">=</span> <span class="n">X_test</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;columns&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Fit on train data</span>
    <span class="n">clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

    <span class="c1"># Evaluate on test data</span>
    <span class="n">y_test_scores</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">test_results</span> <span class="o">=</span> <span class="n">evaluate_predictions</span><span class="p">(</span>
        <span class="n">y_true</span><span class="o">=</span><span class="n">y_test</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
        <span class="n">y_pred_scores</span><span class="o">=</span><span class="n">y_test_scores</span><span class="p">,</span>
        <span class="n">sensitive_attribute</span><span class="o">=</span><span class="n">s_test</span><span class="p">,</span>
        <span class="n">threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Optionally, save test scores DF</span>
    <span class="k">if</span> <span class="n">save_scores_df_path</span><span class="p">:</span>
        <span class="n">scores_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s2">&quot;risk_score&quot;</span><span class="p">:</span> <span class="n">y_test_scores</span><span class="p">,</span>
            <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">y_test</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="n">scores_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">save_scores_df_path</span><span class="p">)</span>
        <span class="n">test_results</span><span class="p">[</span><span class="s2">&quot;predictions_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">save_scores_df_path</span>

    <span class="k">return</span> <span class="n">test_results</span>

<span class="k">def</span><span class="w"> </span><span class="nf">run_baselines</span><span class="p">(</span><span class="n">baselines</span><span class="p">,</span> <span class="n">tasks</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run baseline classifiers on all acs tasks.&quot;&quot;&quot;</span>
    <span class="n">baseline_results</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>

    <span class="c1"># Prepare progress bar</span>
    <span class="n">progress_bar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span>
        <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">tasks</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">baselines</span><span class="p">),</span>
        <span class="n">leave</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">:</span>
        <span class="n">progress_bar</span><span class="o">.</span><span class="n">set_postfix</span><span class="p">({</span><span class="s2">&quot;task&quot;</span><span class="p">:</span> <span class="n">task</span><span class="p">})</span>

        <span class="c1"># Load ACS task data</span>
        <span class="n">acs_dataset</span> <span class="o">=</span> <span class="n">ACSDataset</span><span class="o">.</span><span class="n">make_from_task</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">task</span><span class="p">,</span> <span class="n">cache_dir</span><span class="o">=</span><span class="n">DATA_DIR</span><span class="p">)</span>

        <span class="c1"># Get train/test data</span>
        <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span> <span class="o">=</span> <span class="n">acs_dataset</span><span class="o">.</span><span class="n">get_train</span><span class="p">()</span>
        <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">acs_dataset</span><span class="o">.</span><span class="n">get_test</span><span class="p">()</span>

        <span class="c1"># Get sensitive attribute test data</span>
        <span class="n">s_test</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">acs_dataset</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">sensitive_attribute</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">s_test</span> <span class="o">=</span> <span class="n">acs_dataset</span><span class="o">.</span><span class="n">get_sensitive_attribute_data</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">y_test</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">clf_name</span><span class="p">,</span> <span class="n">clf</span> <span class="ow">in</span> <span class="n">baselines</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">progress_bar</span><span class="o">.</span><span class="n">set_postfix</span><span class="p">({</span><span class="s2">&quot;task&quot;</span><span class="p">:</span> <span class="n">task</span><span class="p">,</span> <span class="s2">&quot;clf&quot;</span><span class="p">:</span> <span class="n">clf_name</span><span class="p">})</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">baseline_results</span><span class="p">[</span><span class="n">task</span><span class="p">][</span><span class="n">clf_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit_and_eval</span><span class="p">(</span>
                    <span class="n">clf</span><span class="o">=</span><span class="n">clf</span><span class="p">,</span>
                    <span class="n">X_train</span><span class="o">=</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="o">=</span><span class="n">y_train</span><span class="p">,</span>
                    <span class="n">X_test</span><span class="o">=</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="o">=</span><span class="n">y_test</span><span class="p">,</span> <span class="n">s_test</span><span class="o">=</span><span class="n">s_test</span><span class="p">,</span>
                    <span class="n">fillna</span><span class="o">=</span><span class="p">(</span><span class="n">clf_name</span> <span class="o">==</span> <span class="s2">&quot;LR&quot;</span><span class="p">),</span>
                    <span class="n">save_scores_df_path</span><span class="o">=</span><span class="n">ACS_AGG_RESULTS_PATH</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;baseline_scores.</span><span class="si">{</span><span class="n">clf_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">task</span><span class="si">}</span><span class="s2">.csv&quot;</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">progress_bar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">baseline_results</span>
</pre></div>
</div>
</div>
<p>Flatten results and add extra columns.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">parse_baseline_results</span><span class="p">(</span><span class="n">baseline_results</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Flatten and parse baseline results.&quot;&quot;&quot;</span>
    <span class="n">parsed_results_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">task</span><span class="p">,</span> <span class="n">task_results</span> <span class="ow">in</span> <span class="n">baseline_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

        <span class="k">for</span> <span class="n">clf</span><span class="p">,</span> <span class="n">clf_results</span> <span class="ow">in</span> <span class="n">task_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">parsed_results</span> <span class="o">=</span> <span class="n">clf_results</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="n">parsed_results</span><span class="p">[</span><span class="s2">&quot;config_task_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">task</span>
            <span class="n">parsed_results</span><span class="p">[</span><span class="s2">&quot;config_model_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">clf</span>
            <span class="n">parsed_results</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">clf</span>
            <span class="n">parsed_results</span><span class="p">[</span><span class="s2">&quot;num_features&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">parsed_results</span><span class="p">[</span><span class="s2">&quot;uses_all_features&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="n">parsed_results_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parsed_results</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">parsed_results_list</span>
</pre></div>
</div>
</div>
<p>Check if baseline results were already computed. If so, load csv; otherwise, compute and save.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">BASELINE_RESULTS_PATH</span> <span class="o">=</span> <span class="n">ACS_AGG_RESULTS_PATH</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="p">(</span><span class="s2">&quot;baseline-results.&quot;</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">baselines</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="o">+</span> <span class="s2">&quot;.csv&quot;</span><span class="p">)</span>

<span class="c1"># If saved results exists: load</span>
<span class="k">if</span> <span class="n">BASELINE_RESULTS_PATH</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading pre-computed baseline results from </span><span class="si">{</span><span class="n">BASELINE_RESULTS_PATH</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">baselines_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">BASELINE_RESULTS_PATH</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># Compute baseline results</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Computing baseline results and saving to </span><span class="si">{</span><span class="n">BASELINE_RESULTS_PATH</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># Compute baseline results</span>
    <span class="n">baseline_results</span> <span class="o">=</span> <span class="n">run_baselines</span><span class="p">(</span><span class="n">baselines</span><span class="p">,</span> <span class="n">tasks</span><span class="o">=</span><span class="n">ALL_TASKS</span><span class="p">)</span>

    <span class="c1"># Parse results</span>
    <span class="n">parsed_results_list</span> <span class="o">=</span> <span class="n">parse_baseline_results</span><span class="p">(</span><span class="n">baseline_results</span><span class="p">)</span>

    <span class="c1"># Construct DF</span>
    <span class="n">baselines_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">parsed_results_list</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">parsed_results_list</span><span class="p">])</span>

    <span class="c1"># Save DF to disk</span>
    <span class="n">baselines_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">BASELINE_RESULTS_PATH</span><span class="p">)</span>

<span class="c1"># Untie indices</span>
<span class="n">baselines_df</span><span class="p">[</span><span class="s2">&quot;new_index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">r</span><span class="p">[</span><span class="n">task_col</span><span class="p">])</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">baselines_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()]</span>
<span class="n">baselines_df</span> <span class="o">=</span> <span class="n">baselines_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;new_index&quot;</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Show 2 random rows</span>
<span class="n">baselines_df</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Loading pre-computed baseline results from ../results/baseline-results.GBM.LR.XGBoost.csv
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>threshold</th>
      <th>n_samples</th>
      <th>n_positives</th>
      <th>n_negatives</th>
      <th>model_name</th>
      <th>accuracy</th>
      <th>tpr</th>
      <th>fnr</th>
      <th>fpr</th>
      <th>tnr</th>
      <th>...</th>
      <th>equalized_odds_diff</th>
      <th>roc_auc</th>
      <th>ece</th>
      <th>ece_quantile</th>
      <th>predictions_path</th>
      <th>config_task_name</th>
      <th>config_model_name</th>
      <th>name</th>
      <th>num_features</th>
      <th>uses_all_features</th>
    </tr>
    <tr>
      <th>new_index</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>XGBoost_ACSPublicCoverage</th>
      <td>0.5</td>
      <td>113829</td>
      <td>33971</td>
      <td>79858</td>
      <td>NaN</td>
      <td>0.801650</td>
      <td>0.515175</td>
      <td>0.484825</td>
      <td>0.076486</td>
      <td>0.923514</td>
      <td>...</td>
      <td>0.368044</td>
      <td>0.839742</td>
      <td>0.004371</td>
      <td>0.004271</td>
      <td>/fast/groups/sf/folktexts-results/2024-07-03/b...</td>
      <td>ACSPublicCoverage</td>
      <td>XGBoost</td>
      <td>XGBoost</td>
      <td>-1</td>
      <td>True</td>
    </tr>
    <tr>
      <th>GBM_ACSIncome</th>
      <td>0.5</td>
      <td>166450</td>
      <td>61233</td>
      <td>105217</td>
      <td>NaN</td>
      <td>0.813584</td>
      <td>0.727973</td>
      <td>0.272027</td>
      <td>0.136594</td>
      <td>0.863406</td>
      <td>...</td>
      <td>0.630389</td>
      <td>0.890792</td>
      <td>0.007721</td>
      <td>0.007146</td>
      <td>/fast/groups/sf/folktexts-results/2024-07-03/b...</td>
      <td>ACSIncome</td>
      <td>GBM</td>
      <td>GBM</td>
      <td>-1</td>
      <td>True</td>
    </tr>
  </tbody>
</table>
<p>2 rows × 42 columns</p>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">all_results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">results_df</span><span class="p">,</span> <span class="n">baselines_df</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">all_results_df</span><span class="o">.</span><span class="n">shape</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
all_results_df.shape=(185, 64)
</pre></div></div>
</div>
</section>
<section id="Prepare-results-table-for-each-task">
<h2>Prepare results table for each task<a class="headerlink" href="#Prepare-results-table-for-each-task" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">table_metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ece&quot;</span><span class="p">,</span> <span class="s2">&quot;brier_score_loss&quot;</span><span class="p">,</span> <span class="s2">&quot;roc_auc&quot;</span><span class="p">,</span> <span class="s2">&quot;accuracy&quot;</span><span class="p">,</span> <span class="s2">&quot;fit_thresh_accuracy&quot;</span><span class="p">,</span> <span class="s2">&quot;score_stdev&quot;</span><span class="p">]</span> <span class="c1">#, &quot;score_mean&quot;]</span>
</pre></div>
</div>
</div>
<p>Add model size and model family columns:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">folktexts.llm_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_model_size_B</span>

<span class="n">all_results_df</span><span class="p">[</span><span class="s2">&quot;model_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span>
        <span class="n">get_model_size_B</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>  <span class="c1"># Set GPT 4o size as the largest (300B)</span>
        <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">baselines</span> <span class="k">else</span> <span class="s2">&quot;-&quot;</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">all_results_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()</span>
<span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_model_family</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="s2">&quot;gpt&quot;</span> <span class="ow">in</span> <span class="n">model_name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
        <span class="k">return</span> <span class="s2">&quot;OpenAI&quot;</span>
    <span class="k">elif</span> <span class="s2">&quot;llama&quot;</span> <span class="ow">in</span> <span class="n">model_name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
        <span class="k">return</span> <span class="s2">&quot;Llama&quot;</span>
    <span class="k">elif</span> <span class="s2">&quot;mistral&quot;</span> <span class="ow">in</span> <span class="n">model_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="s2">&quot;mixtral&quot;</span> <span class="ow">in</span> <span class="n">model_name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
        <span class="k">return</span> <span class="s2">&quot;Mistral&quot;</span>
    <span class="k">elif</span> <span class="s2">&quot;gemma&quot;</span> <span class="ow">in</span> <span class="n">model_name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
        <span class="k">return</span> <span class="s2">&quot;Gemma&quot;</span>
    <span class="k">elif</span> <span class="s2">&quot;yi&quot;</span> <span class="ow">in</span> <span class="n">model_name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
        <span class="k">return</span> <span class="s2">&quot;Yi&quot;</span>
    <span class="k">elif</span> <span class="s2">&quot;qwen&quot;</span> <span class="ow">in</span> <span class="n">model_name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
        <span class="k">return</span> <span class="s2">&quot;Qwen&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;-&quot;</span>

<span class="n">all_results_df</span><span class="p">[</span><span class="s2">&quot;model_family&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_model_family</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">model_col</span><span class="p">])</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">all_results_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()]</span>
<span class="n">all_results_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">task_col</span><span class="p">,</span> <span class="s2">&quot;model_family&quot;</span><span class="p">])[</span><span class="s2">&quot;accuracy&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
config_task_name   model_family
ACSEmployment      -                3
                   Gemma            8
                   Llama            8
                   Mistral         12
                   OpenAI           2
                   Yi               4
ACSIncome          -                3
                   Gemma            8
                   Llama            8
                   Mistral         12
                   OpenAI           2
                   Yi               4
ACSMobility        -                3
                   Gemma            8
                   Llama            8
                   Mistral         12
                   OpenAI           2
                   Yi               4
ACSPublicCoverage  -                3
                   Gemma            8
                   Llama            8
                   Mistral         12
                   OpenAI           2
                   Yi               4
ACSTravelTime      -                3
                   Gemma            8
                   Llama            8
                   Mistral         12
                   OpenAI           2
                   Yi               4
Name: accuracy, dtype: int64
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">model_sort_key</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">task_df</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Sort key for paper table rows.&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="s2">&quot;gpt&quot;</span> <span class="ow">in</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
        <span class="n">key</span> <span class="o">=</span> <span class="mi">11</span>
    <span class="k">elif</span> <span class="s2">&quot;llama&quot;</span> <span class="ow">in</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
        <span class="n">key</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="k">elif</span> <span class="s2">&quot;mixtral&quot;</span> <span class="ow">in</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
        <span class="n">key</span> <span class="o">=</span> <span class="mi">9</span>
    <span class="k">elif</span> <span class="s2">&quot;mistral&quot;</span> <span class="ow">in</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
        <span class="n">key</span> <span class="o">=</span> <span class="mi">8</span>
    <span class="k">elif</span> <span class="s2">&quot;yi&quot;</span> <span class="ow">in</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
        <span class="n">key</span> <span class="o">=</span> <span class="mi">7</span>
    <span class="k">elif</span> <span class="s2">&quot;gemma&quot;</span> <span class="ow">in</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
        <span class="n">key</span> <span class="o">=</span> <span class="mi">6</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>

    <span class="n">row</span> <span class="o">=</span> <span class="n">task_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
    <span class="c1"># return (1e5 * key) + (row[&quot;model_size&quot;] * 100) + int(row[&quot;is_inst&quot;] * 10) + (1 if row[numeric_prompt_col] else 0)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;model_size&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e9</span><span class="p">)</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;is_inst&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e3</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="n">numeric_prompt_col</span><span class="p">]</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">key</span>
<br/></pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">latex_colored_float_format</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">all_values</span><span class="p">,</span> <span class="n">higher_is_better</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Map a cell&#39;s value to its colored latex code.</span>

<span class="sd">    Current definition:</span>
<span class="sd">    - use cyan color gradient for good values;</span>
<span class="sd">    - use orange color gradient for bad values;</span>
<span class="sd">    - use no color for anything in between;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">min_val</span><span class="p">,</span> <span class="n">max_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">all_values</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">all_values</span><span class="p">)</span>

    <span class="n">low_pct_val</span><span class="p">,</span> <span class="n">high_pct_val</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">min_val</span> <span class="o">+</span> <span class="p">(</span><span class="n">max_val</span> <span class="o">-</span> <span class="n">min_val</span><span class="p">)</span> <span class="o">*</span> <span class="n">interp_point</span>
        <span class="k">for</span> <span class="n">interp_point</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">]</span>
    <span class="p">]</span>

    <span class="c1"># Use rounded value or original value for coloring?</span>
    <span class="c1"># &gt; Using rounded value for consistency in table</span>
    <span class="c1"># val = np.round(val, decimals=2)</span>

    <span class="c1"># Use no color for middle 33% of values</span>
    <span class="k">if</span> <span class="n">low_pct_val</span> <span class="o">&lt;=</span> <span class="n">val</span> <span class="o">&lt;=</span> <span class="n">high_pct_val</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">val</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">if</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="n">low_pct_val</span><span class="p">:</span>
        <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;orange&quot;</span> <span class="k">if</span> <span class="n">higher_is_better</span> <span class="k">else</span> <span class="s2">&quot;cyan&quot;</span>
        <span class="n">color_value</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">low_pct_val</span> <span class="o">-</span> <span class="n">val</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">low_pct_val</span> <span class="o">-</span> <span class="n">min_val</span><span class="p">))</span>

    <span class="k">elif</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="n">high_pct_val</span><span class="p">:</span>
        <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;cyan&quot;</span> <span class="k">if</span> <span class="n">higher_is_better</span> <span class="k">else</span> <span class="s2">&quot;orange&quot;</span>
        <span class="n">color_value</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">val</span> <span class="o">-</span> <span class="n">high_pct_val</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">max_val</span> <span class="o">-</span> <span class="n">high_pct_val</span><span class="p">))</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Note: halving `color_value` to have softer colors</span>
    <span class="n">color_value</span> <span class="o">/=</span> <span class="mi">4</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="sa">r</span><span class="s2">&quot;\cellcolor{&quot;</span>
        <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">color</span><span class="si">}</span><span class="s2">!</span><span class="si">{</span><span class="n">color_value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;} &quot;</span>
        <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">val</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>

<span class="n">higher_is_better_cols</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;roc_auc&quot;</span><span class="p">,</span> <span class="s2">&quot;accuracy&quot;</span><span class="p">,</span> <span class="s2">&quot;fit_thresh_accuracy&quot;</span><span class="p">}</span>
</pre></div>
</div>
</div>
</section>
<section id="Output-latex-results-tables---colored!">
<h2>Output latex results tables - colored!<a class="headerlink" href="#Output-latex-results-tables---colored!" title="Link to this heading"></a></h2>
<p>Set whether to use <strong>Numeric prompting</strong> or <strong>multiple-choice Q&amp;A prompting</strong>!</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># NUMERIC_PROMPTING = False</span>
<span class="n">NUMERIC_PROMPTING</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
</div>
<p>Whether to <strong>combine results from both prompting schemes</strong> in the latex tables:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">COMBINE_PROMPTING_RESULTS</span> <span class="o">=</span> <span class="kc">True</span>
<span class="c1"># COMBINE_PROMPTING_RESULTS = False</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">prettify_model_name</span>

<span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">ALL_TASKS</span><span class="p">:</span>
    <span class="n">task_df</span> <span class="o">=</span> <span class="n">all_results_df</span><span class="p">[</span><span class="n">all_results_df</span><span class="p">[</span><span class="n">task_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">task</span><span class="p">]</span>

    <span class="c1"># Sort table rows</span>
    <span class="n">sorted_df_index</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
        <span class="n">task_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
        <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">id_</span><span class="p">:</span> <span class="n">model_sort_key</span><span class="p">(</span><span class="n">id_</span><span class="p">,</span> <span class="n">task_df</span><span class="p">),</span>
        <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">latex_tab_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">numeric_prompt_col</span><span class="p">]</span> <span class="o">+</span> <span class="n">table_metrics</span>

    <span class="c1"># latex_table = task_df.sort_values([&quot;model_family&quot;, &quot;model_size&quot;, &quot;is_inst&quot;], ascending=False).set_index(model_col)[table_metrics].round(3)</span>
    <span class="n">latex_table</span> <span class="o">=</span> <span class="n">task_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sorted_df_index</span><span class="p">]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">model_col</span><span class="p">)[</span><span class="n">latex_tab_cols</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

    <span class="c1"># Keep rows for a single selected prompting scheme</span>
    <span class="n">latex_table</span> <span class="o">=</span> <span class="n">latex_table</span><span class="p">[</span>
        <span class="p">(</span><span class="n">latex_table</span><span class="p">[</span><span class="n">numeric_prompt_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">NUMERIC_PROMPTING</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">latex_table</span><span class="p">[</span><span class="n">numeric_prompt_col</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span>
    <span class="p">]</span>

    <span class="c1"># But optionally join with the columns of the other prompting scheme</span>
    <span class="k">if</span> <span class="n">COMBINE_PROMPTING_RESULTS</span><span class="p">:</span>
        <span class="n">cols_to_keep</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ece&quot;</span><span class="p">,</span> <span class="s2">&quot;brier_score_loss&quot;</span><span class="p">,</span> <span class="s2">&quot;roc_auc&quot;</span><span class="p">,</span> <span class="s2">&quot;accuracy&quot;</span><span class="p">]</span>
        <span class="n">latex_table</span> <span class="o">=</span> <span class="n">latex_table</span><span class="p">[</span><span class="n">cols_to_keep</span><span class="p">]</span>

        <span class="n">latex_table_other_prompt</span> <span class="o">=</span> <span class="n">task_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sorted_df_index</span><span class="p">]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">model_col</span><span class="p">)</span>
        <span class="n">latex_table_other_prompt</span> <span class="o">=</span> <span class="n">latex_table_other_prompt</span><span class="p">[</span>
            <span class="p">(</span><span class="n">latex_table_other_prompt</span><span class="p">[</span><span class="n">numeric_prompt_col</span><span class="p">]</span> <span class="o">!=</span> <span class="n">NUMERIC_PROMPTING</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">latex_table_other_prompt</span><span class="p">[</span><span class="n">numeric_prompt_col</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span>
        <span class="p">][</span><span class="n">cols_to_keep</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

        <span class="n">latex_table</span> <span class="o">=</span> <span class="n">latex_table</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">latex_table_other_prompt</span><span class="p">,</span>
            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
            <span class="n">lsuffix</span><span class="o">=</span><span class="s2">&quot; (num)&quot;</span> <span class="k">if</span> <span class="n">NUMERIC_PROMPTING</span> <span class="k">else</span> <span class="s2">&quot; (mult. choice)&quot;</span><span class="p">,</span>
            <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;1:1&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># Fill NaNs</span>
    <span class="n">latex_table</span> <span class="o">=</span> <span class="n">latex_table</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>

    <span class="c1"># Prettify model names</span>
    <span class="n">latex_table</span><span class="p">[</span><span class="s2">&quot;Model&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">prettify_model_name</span><span class="p">(</span><span class="n">id_</span><span class="p">)</span> <span class="k">if</span> <span class="n">id_</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">baselines</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="n">id_</span>
        <span class="k">for</span> <span class="n">id_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">latex_table</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()</span>
    <span class="p">]</span>
    <span class="n">latex_table</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;Model&quot;</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">latex_table</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span> <span class="o">-</span> <span class="p">{</span><span class="s2">&quot;score_stdev&quot;</span><span class="p">,</span> <span class="n">numeric_prompt_col</span><span class="p">,</span> <span class="s2">&quot;model_family&quot;</span><span class="p">}:</span>
        <span class="n">index_without_baselines</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">latex_table</span><span class="o">.</span><span class="n">index</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">baselines</span><span class="p">]</span>
        <span class="n">index_baselines</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">baselines</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="n">col_data</span> <span class="o">=</span> <span class="n">latex_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index_without_baselines</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">new_col_data</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">latex_colored_float_format</span><span class="p">(</span>
                <span class="n">val</span><span class="o">=</span><span class="n">col_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">id_</span><span class="p">],</span> <span class="n">all_values</span><span class="o">=</span><span class="n">col_data</span><span class="p">,</span>
                <span class="n">higher_is_better</span><span class="o">=</span><span class="nb">any</span><span class="p">(</span><span class="n">col_name</span> <span class="ow">in</span> <span class="n">col</span> <span class="k">for</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="n">higher_is_better_cols</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">id_</span> <span class="ow">in</span> <span class="n">index_without_baselines</span>
        <span class="p">]</span> <span class="o">+</span> <span class="p">[</span>
            <span class="n">latex_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">id_</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">id_</span> <span class="ow">in</span> <span class="n">index_baselines</span>
        <span class="p">]</span>

        <span class="c1"># Set compatible dtype</span>
        <span class="n">latex_table</span> <span class="o">=</span> <span class="n">latex_table</span><span class="o">.</span><span class="n">astype</span><span class="p">({</span><span class="n">col</span><span class="p">:</span> <span class="nb">str</span><span class="p">})</span>

        <span class="c1"># Set new data</span>
        <span class="n">latex_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index_without_baselines</span> <span class="o">+</span> <span class="n">index_baselines</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_col_data</span>

    <span class="c1"># Drop prompting column of not combining both</span>
    <span class="n">latex_table</span> <span class="o">=</span> <span class="n">latex_table</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">numeric_prompt_col</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>

    <span class="c1"># Rename columns to be latex compatible</span>
    <span class="n">latex_table</span> <span class="o">=</span> <span class="n">latex_table</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="n">col</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">latex_table</span><span class="o">.</span><span class="n">columns</span><span class="p">})</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;*** </span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> ***</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">latex_table_str</span> <span class="o">=</span> <span class="n">latex_table</span><span class="o">.</span><span class="n">to_latex</span><span class="p">(</span><span class="n">float_format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%.2f</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">latex_table_str</span><span class="p">)</span>

    <span class="n">tables_dir</span> <span class="o">=</span> <span class="n">ACS_AGG_RESULTS_PATH</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;tables&quot;</span>
    <span class="n">tables_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tables_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">task</span><span class="si">}</span><span class="s2">-table.</span><span class="si">{</span><span class="n">COMBINE_PROMPTING_RESULTS</span><span class="si">=}</span><span class="s2">.</span><span class="si">{</span><span class="n">NUMERIC_PROMPTING</span><span class="si">=}</span><span class="s2">.tex&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_out</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">latex_table_str</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">f_out</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
*** ACSINCOME ***

\begin{tabular}{lllllllll}
\toprule
 &amp; ece (num) &amp; brier score loss (num) &amp; roc auc (num) &amp; accuracy (num) &amp; ece &amp; brier score loss &amp; roc auc &amp; accuracy \\
Model &amp;  &amp;  &amp;  &amp;  &amp;  &amp;  &amp;  &amp;  \\
\midrule
GPT 4o mini (it) &amp; \cellcolor{cyan!25.0} 0.05 &amp; \cellcolor{cyan!25.0} 0.16 &amp; \cellcolor{cyan!20.6} 0.83 &amp; \cellcolor{cyan!24.4} 0.78 &amp; 0.24 &amp; 0.24 &amp; \cellcolor{cyan!17.6} 0.85 &amp; 0.74 \\
Mixtral 8x22B (it) &amp; 0.11 &amp; \cellcolor{cyan!15.5} 0.17 &amp; \cellcolor{cyan!25.0} 0.84 &amp; \cellcolor{cyan!18.9} 0.77 &amp; 0.21 &amp; \cellcolor{cyan!3.6} 0.22 &amp; \cellcolor{cyan!11.2} 0.85 &amp; \cellcolor{cyan!11.1} 0.76 \\
Mixtral 8x22B &amp; 0.13 &amp; \cellcolor{cyan!3.6} 0.18 &amp; \cellcolor{cyan!9.6} 0.82 &amp; \cellcolor{cyan!2.4} 0.74 &amp; \cellcolor{cyan!13.2} 0.17 &amp; \cellcolor{cyan!21.6} 0.19 &amp; \cellcolor{cyan!16.5} 0.85 &amp; 0.68 \\
Llama 3 70B (it) &amp; 0.25 &amp; 0.23 &amp; \cellcolor{cyan!22.1} 0.84 &amp; 0.67 &amp; 0.27 &amp; 0.27 &amp; \cellcolor{cyan!25.0} 0.86 &amp; 0.69 \\
Llama 3 70B &amp; 0.27 &amp; 0.24 &amp; \cellcolor{cyan!6.7} 0.82 &amp; 0.54 &amp; 0.20 &amp; \cellcolor{cyan!14.9} 0.20 &amp; \cellcolor{cyan!20.8} 0.86 &amp; 0.70 \\
Mixtral 8x7B (it) &amp; 0.10 &amp; \cellcolor{cyan!15.5} 0.17 &amp; \cellcolor{cyan!22.8} 0.84 &amp; \cellcolor{cyan!12.8} 0.76 &amp; \cellcolor{cyan!16.8} 0.16 &amp; \cellcolor{cyan!25.0} 0.18 &amp; \cellcolor{cyan!19.7} 0.86 &amp; \cellcolor{cyan!25.0} 0.78 \\
Mixtral 8x7B &amp; \cellcolor{cyan!4.0} 0.07 &amp; \cellcolor{cyan!13.1} 0.17 &amp; \cellcolor{cyan!3.7} 0.81 &amp; \cellcolor{cyan!25.0} 0.78 &amp; \cellcolor{cyan!10.6} 0.17 &amp; \cellcolor{cyan!11.5} 0.21 &amp; 0.83 &amp; 0.65 \\
Yi 34B (it) &amp; 0.22 &amp; 0.21 &amp; 0.80 &amp; 0.48 &amp; \cellcolor{cyan!1.3} 0.19 &amp; \cellcolor{cyan!18.8} 0.19 &amp; \cellcolor{cyan!19.7} 0.86 &amp; 0.72 \\
Yi 34B &amp; 0.15 &amp; 0.19 &amp; \cellcolor{cyan!17.7} 0.83 &amp; 0.61 &amp; 0.25 &amp; \cellcolor{cyan!2.5} 0.22 &amp; \cellcolor{cyan!13.3} 0.85 &amp; 0.62 \\
Llama 3 8B (it) &amp; 0.23 &amp; 0.23 &amp; \cellcolor{cyan!0.1} 0.81 &amp; 0.67 &amp; 0.32 &amp; 0.30 &amp; \cellcolor{cyan!13.3} 0.85 &amp; 0.62 \\
Llama 3 8B &amp; 0.14 &amp; 0.24 &amp; 0.63 &amp; \cellcolor{orange!3.7} 0.40 &amp; 0.25 &amp; 0.26 &amp; 0.81 &amp; \cellcolor{orange!20.8} 0.38 \\
Mistral 7B (it) &amp; 0.16 &amp; 0.19 &amp; \cellcolor{cyan!14.7} 0.83 &amp; 0.70 &amp; 0.21 &amp; \cellcolor{cyan!4.7} 0.22 &amp; 0.83 &amp; \cellcolor{cyan!16.5} 0.77 \\
Gemma 7B (it) &amp; 0.33 &amp; 0.30 &amp; 0.78 &amp; 0.42 &amp; \cellcolor{orange!14.7} 0.61 &amp; \cellcolor{orange!4.7} 0.59 &amp; \cellcolor{cyan!3.8} 0.84 &amp; \cellcolor{orange!25.0} 0.37 \\
Mistral 7B &amp; \cellcolor{orange!15.7} 0.36 &amp; 0.32 &amp; 0.75 &amp; 0.49 &amp; 0.20 &amp; 0.23 &amp; 0.80 &amp; 0.73 \\
Gemma 7B &amp; 0.15 &amp; 0.20 &amp; 0.80 &amp; 0.73 &amp; 0.24 &amp; 0.27 &amp; 0.76 &amp; \cellcolor{orange!25.0} 0.37 \\
Gemma 2B (it) &amp; 0.28 &amp; 0.31 &amp; \cellcolor{orange!25.0} 0.50 &amp; \cellcolor{orange!25.0} 0.37 &amp; \cellcolor{orange!25.0} 0.63 &amp; \cellcolor{orange!25.0} 0.63 &amp; 0.73 &amp; \cellcolor{orange!25.0} 0.37 \\
Gemma 2B &amp; \cellcolor{orange!25.0} 0.37 &amp; \cellcolor{orange!25.0} 0.37 &amp; \cellcolor{orange!25.0} 0.50 &amp; 0.63 &amp; \cellcolor{cyan!25.0} 0.14 &amp; 0.25 &amp; \cellcolor{orange!25.0} 0.62 &amp; 0.45 \\
LR &amp; 0.03 &amp; 0.18 &amp; 0.79 &amp; 0.74 &amp; 0.03 &amp; 0.18 &amp; 0.79 &amp; 0.74 \\
GBM &amp; 0.01 &amp; 0.13 &amp; 0.89 &amp; 0.81 &amp; 0.01 &amp; 0.13 &amp; 0.89 &amp; 0.81 \\
XGBoost &amp; 0.00 &amp; 0.13 &amp; 0.90 &amp; 0.82 &amp; 0.00 &amp; 0.13 &amp; 0.90 &amp; 0.82 \\
\bottomrule
\end{tabular}


*** ACSMOBILITY ***

\begin{tabular}{lllllllll}
\toprule
 &amp; ece (num) &amp; brier score loss (num) &amp; roc auc (num) &amp; accuracy (num) &amp; ece &amp; brier score loss &amp; roc auc &amp; accuracy \\
Model &amp;  &amp;  &amp;  &amp;  &amp;  &amp;  &amp;  &amp;  \\
\midrule
GPT 4o mini (it) &amp; 0.22 &amp; 0.25 &amp; 0.49 &amp; \cellcolor{cyan!25.0} 0.73 &amp; 0.26 &amp; 0.26 &amp; \cellcolor{cyan!0.6} 0.57 &amp; \cellcolor{cyan!25.0} 0.73 \\
Mixtral 8x22B (it) &amp; 0.05 &amp; \cellcolor{cyan!17.9} 0.20 &amp; \cellcolor{cyan!25.0} 0.54 &amp; \cellcolor{cyan!25.0} 0.73 &amp; 0.40 &amp; 0.40 &amp; \cellcolor{orange!12.8} 0.51 &amp; 0.39 \\
Mixtral 8x22B &amp; 0.13 &amp; 0.22 &amp; 0.49 &amp; \cellcolor{cyan!25.0} 0.73 &amp; \cellcolor{cyan!10.2} 0.11 &amp; \cellcolor{cyan!21.2} 0.21 &amp; 0.55 &amp; \cellcolor{cyan!25.0} 0.73 \\
Llama 3 70B (it) &amp; 0.05 &amp; \cellcolor{cyan!10.7} 0.20 &amp; 0.52 &amp; \cellcolor{cyan!25.0} 0.73 &amp; 0.20 &amp; \cellcolor{cyan!1.5} 0.25 &amp; 0.57 &amp; 0.58 \\
Llama 3 70B &amp; 0.06 &amp; \cellcolor{cyan!7.1} 0.20 &amp; 0.53 &amp; \cellcolor{cyan!20.7} 0.73 &amp; 0.22 &amp; \cellcolor{cyan!4.8} 0.24 &amp; 0.55 &amp; 0.53 \\
Mixtral 8x7B (it) &amp; 0.11 &amp; 0.21 &amp; 0.51 &amp; \cellcolor{cyan!25.0} 0.73 &amp; 0.26 &amp; 0.26 &amp; \cellcolor{cyan!12.8} 0.58 &amp; \cellcolor{cyan!25.0} 0.73 \\
Mixtral 8x7B &amp; 0.24 &amp; 0.25 &amp; \cellcolor{orange!25.0} 0.48 &amp; \cellcolor{cyan!25.0} 0.73 &amp; \cellcolor{cyan!0.8} 0.14 &amp; \cellcolor{cyan!18.9} 0.21 &amp; 0.57 &amp; \cellcolor{cyan!25.0} 0.73 \\
Yi 34B (it) &amp; 0.23 &amp; 0.25 &amp; 0.50 &amp; \cellcolor{orange!25.0} 0.27 &amp; \cellcolor{cyan!18.2} 0.09 &amp; \cellcolor{cyan!23.1} 0.20 &amp; 0.56 &amp; \cellcolor{cyan!15.4} 0.72 \\
Yi 34B &amp; 0.15 &amp; 0.23 &amp; 0.52 &amp; 0.44 &amp; \cellcolor{cyan!25.0} 0.07 &amp; \cellcolor{cyan!25.0} 0.20 &amp; 0.57 &amp; \cellcolor{cyan!20.7} 0.73 \\
Llama 3 8B (it) &amp; 0.11 &amp; 0.21 &amp; 0.49 &amp; \cellcolor{cyan!23.4} 0.73 &amp; 0.15 &amp; \cellcolor{cyan!13.7} 0.22 &amp; 0.56 &amp; \cellcolor{cyan!5.3} 0.70 \\
Llama 3 8B &amp; 0.14 &amp; 0.21 &amp; 0.51 &amp; \cellcolor{cyan!19.1} 0.72 &amp; \cellcolor{cyan!12.5} 0.10 &amp; \cellcolor{cyan!21.7} 0.20 &amp; 0.55 &amp; \cellcolor{cyan!24.5} 0.73 \\
Mistral 7B (it) &amp; 0.17 &amp; 0.23 &amp; 0.49 &amp; \cellcolor{cyan!24.5} 0.73 &amp; 0.26 &amp; 0.26 &amp; 0.57 &amp; \cellcolor{cyan!25.0} 0.73 \\
Gemma 7B (it) &amp; \cellcolor{orange!8.9} 0.25 &amp; 0.26 &amp; \cellcolor{orange!3.1} 0.49 &amp; \cellcolor{cyan!22.3} 0.73 &amp; 0.25 &amp; 0.26 &amp; \cellcolor{cyan!25.0} 0.58 &amp; \cellcolor{cyan!21.8} 0.73 \\
Mistral 7B &amp; \cellcolor{orange!25.0} 0.27 &amp; \cellcolor{orange!25.0} 0.27 &amp; 0.50 &amp; \cellcolor{cyan!25.0} 0.73 &amp; 0.20 &amp; \cellcolor{cyan!8.6} 0.23 &amp; 0.53 &amp; \cellcolor{cyan!23.4} 0.73 \\
Gemma 7B &amp; 0.19 &amp; 0.24 &amp; 0.49 &amp; \cellcolor{cyan!25.0} 0.73 &amp; 0.41 &amp; 0.37 &amp; \cellcolor{orange!25.0} 0.50 &amp; \cellcolor{orange!25.0} 0.27 \\
Gemma 2B (it) &amp; \cellcolor{cyan!25.0} 0.02 &amp; \cellcolor{cyan!25.0} 0.20 &amp; 0.50 &amp; \cellcolor{cyan!25.0} 0.73 &amp; \cellcolor{orange!25.0} 0.73 &amp; \cellcolor{orange!25.0} 0.73 &amp; 0.52 &amp; \cellcolor{orange!25.0} 0.27 \\
Gemma 2B &amp; \cellcolor{orange!25.0} 0.27 &amp; \cellcolor{orange!25.0} 0.27 &amp; 0.50 &amp; \cellcolor{cyan!25.0} 0.73 &amp; 0.25 &amp; 0.26 &amp; 0.51 &amp; 0.34 \\
LR &amp; 0.02 &amp; 0.19 &amp; 0.61 &amp; 0.74 &amp; 0.02 &amp; 0.19 &amp; 0.61 &amp; 0.74 \\
GBM &amp; 0.01 &amp; 0.17 &amp; 0.74 &amp; 0.76 &amp; 0.01 &amp; 0.17 &amp; 0.74 &amp; 0.76 \\
XGBoost &amp; 0.00 &amp; 0.16 &amp; 0.74 &amp; 0.76 &amp; 0.00 &amp; 0.16 &amp; 0.74 &amp; 0.76 \\
\bottomrule
\end{tabular}


*** ACSEMPLOYMENT ***

\begin{tabular}{lllllllll}
\toprule
 &amp; ece (num) &amp; brier score loss (num) &amp; roc auc (num) &amp; accuracy (num) &amp; ece &amp; brier score loss &amp; roc auc &amp; accuracy \\
Model &amp;  &amp;  &amp;  &amp;  &amp;  &amp;  &amp;  &amp;  \\
\midrule
GPT 4o mini (it) &amp; 0.23 &amp; 0.23 &amp; 0.80 &amp; 0.73 &amp; 0.28 &amp; 0.29 &amp; 0.79 &amp; 0.65 \\
Mixtral 8x22B (it) &amp; 0.06 &amp; \cellcolor{cyan!21.9} 0.14 &amp; \cellcolor{cyan!24.4} 0.87 &amp; \cellcolor{cyan!16.5} 0.79 &amp; \cellcolor{orange!23.0} 0.38 &amp; \cellcolor{orange!8.0} 0.39 &amp; 0.60 &amp; 0.51 \\
Mixtral 8x22B &amp; 0.15 &amp; 0.18 &amp; 0.82 &amp; \cellcolor{cyan!20.7} 0.80 &amp; 0.21 &amp; 0.24 &amp; \cellcolor{cyan!25.0} 0.86 &amp; 0.52 \\
Llama 3 70B (it) &amp; \cellcolor{cyan!0.7} 0.05 &amp; \cellcolor{cyan!25.0} 0.14 &amp; \cellcolor{cyan!25.0} 0.88 &amp; \cellcolor{cyan!25.0} 0.81 &amp; 0.17 &amp; \cellcolor{cyan!17.1} 0.19 &amp; \cellcolor{cyan!23.3} 0.85 &amp; \cellcolor{cyan!15.4} 0.73 \\
Llama 3 70B &amp; 0.05 &amp; \cellcolor{cyan!16.7} 0.15 &amp; \cellcolor{cyan!13.6} 0.86 &amp; \cellcolor{cyan!5.8} 0.78 &amp; 0.25 &amp; 0.26 &amp; \cellcolor{cyan!2.3} 0.82 &amp; 0.52 \\
Mixtral 8x7B (it) &amp; 0.07 &amp; \cellcolor{cyan!16.7} 0.15 &amp; \cellcolor{cyan!23.2} 0.87 &amp; \cellcolor{cyan!7.2} 0.78 &amp; 0.22 &amp; 0.24 &amp; \cellcolor{cyan!6.8} 0.82 &amp; \cellcolor{cyan!13.7} 0.73 \\
Mixtral 8x7B &amp; 0.08 &amp; 0.17 &amp; 0.81 &amp; 0.73 &amp; 0.30 &amp; 0.31 &amp; \cellcolor{cyan!1.1} 0.81 &amp; \cellcolor{orange!24.1} 0.45 \\
Yi 34B (it) &amp; 0.15 &amp; 0.21 &amp; 0.81 &amp; 0.51 &amp; 0.14 &amp; 0.21 &amp; 0.79 &amp; 0.69 \\
Yi 34B &amp; 0.13 &amp; 0.23 &amp; 0.66 &amp; 0.50 &amp; 0.08 &amp; 0.23 &amp; 0.70 &amp; 0.62 \\
Llama 3 8B (it) &amp; 0.08 &amp; 0.17 &amp; 0.82 &amp; 0.77 &amp; 0.07 &amp; \cellcolor{cyan!25.0} 0.19 &amp; 0.79 &amp; \cellcolor{cyan!25.0} 0.74 \\
Llama 3 8B &amp; 0.15 &amp; 0.23 &amp; 0.75 &amp; \cellcolor{orange!25.0} 0.46 &amp; 0.34 &amp; 0.34 &amp; 0.76 &amp; \cellcolor{orange!25.0} 0.45 \\
Mistral 7B (it) &amp; \cellcolor{cyan!7.4} 0.04 &amp; 0.19 &amp; 0.79 &amp; 0.69 &amp; \cellcolor{orange!6.6} 0.35 &amp; 0.36 &amp; 0.72 &amp; 0.63 \\
Gemma 7B (it) &amp; \cellcolor{cyan!8.8} 0.04 &amp; 0.22 &amp; 0.71 &amp; 0.60 &amp; \cellcolor{orange!10.0} 0.36 &amp; 0.38 &amp; 0.59 &amp; 0.58 \\
Mistral 7B &amp; 0.14 &amp; 0.19 &amp; 0.80 &amp; \cellcolor{cyan!12.9} 0.79 &amp; 0.26 &amp; 0.30 &amp; 0.76 &amp; \cellcolor{orange!25.0} 0.45 \\
Gemma 7B &amp; \cellcolor{orange!25.0} 0.35 &amp; \cellcolor{orange!25.0} 0.38 &amp; \cellcolor{orange!1.6} 0.50 &amp; 0.51 &amp; 0.15 &amp; 0.25 &amp; 0.65 &amp; \cellcolor{orange!4.1} 0.48 \\
Gemma 2B (it) &amp; 0.12 &amp; 0.27 &amp; \cellcolor{orange!25.0} 0.46 &amp; \cellcolor{orange!25.0} 0.46 &amp; \cellcolor{orange!25.0} 0.38 &amp; \cellcolor{orange!25.0} 0.41 &amp; \cellcolor{orange!25.0} 0.42 &amp; \cellcolor{orange!16.3} 0.46 \\
Gemma 2B &amp; \cellcolor{cyan!25.0} 0.01 &amp; 0.23 &amp; 0.57 &amp; 0.53 &amp; \cellcolor{cyan!25.0} 0.01 &amp; 0.24 &amp; 0.63 &amp; 0.54 \\
LR &amp; 0.02 &amp; 0.15 &amp; 0.86 &amp; 0.78 &amp; 0.02 &amp; 0.15 &amp; 0.86 &amp; 0.78 \\
GBM &amp; 0.00 &amp; 0.12 &amp; 0.91 &amp; 0.83 &amp; 0.00 &amp; 0.12 &amp; 0.91 &amp; 0.83 \\
XGBoost &amp; 0.00 &amp; 0.12 &amp; 0.91 &amp; 0.83 &amp; 0.00 &amp; 0.12 &amp; 0.91 &amp; 0.83 \\
\bottomrule
\end{tabular}


*** ACSTRAVELTIME ***

\begin{tabular}{lllllllll}
\toprule
 &amp; ece (num) &amp; brier score loss (num) &amp; roc auc (num) &amp; accuracy (num) &amp; ece &amp; brier score loss &amp; roc auc &amp; accuracy \\
Model &amp;  &amp;  &amp;  &amp;  &amp;  &amp;  &amp;  &amp;  \\
\midrule
GPT 4o mini (it) &amp; 0.15 &amp; 0.27 &amp; 0.58 &amp; 0.57 &amp; 0.39 &amp; 0.40 &amp; 0.65 &amp; 0.55 \\
Mixtral 8x22B (it) &amp; 0.12 &amp; \cellcolor{cyan!23.7} 0.24 &amp; \cellcolor{cyan!23.5} 0.64 &amp; \cellcolor{cyan!25.0} 0.59 &amp; 0.31 &amp; 0.33 &amp; 0.66 &amp; \cellcolor{cyan!17.1} 0.59 \\
Mixtral 8x22B &amp; 0.30 &amp; 0.34 &amp; 0.57 &amp; \cellcolor{cyan!2.4} 0.58 &amp; 0.20 &amp; 0.28 &amp; 0.63 &amp; \cellcolor{orange!25.0} 0.44 \\
Llama 3 70B (it) &amp; 0.12 &amp; \cellcolor{cyan!22.5} 0.24 &amp; \cellcolor{cyan!25.0} 0.64 &amp; 0.53 &amp; 0.15 &amp; \cellcolor{cyan!22.6} 0.24 &amp; \cellcolor{cyan!25.0} 0.70 &amp; \cellcolor{cyan!25.0} 0.60 \\
Llama 3 70B &amp; 0.08 &amp; \cellcolor{cyan!12.4} 0.25 &amp; 0.52 &amp; 0.46 &amp; 0.09 &amp; \cellcolor{cyan!21.4} 0.24 &amp; 0.67 &amp; 0.55 \\
Mixtral 8x7B (it) &amp; 0.09 &amp; \cellcolor{cyan!25.0} 0.24 &amp; 0.61 &amp; 0.57 &amp; \cellcolor{orange!25.0} 0.45 &amp; \cellcolor{orange!25.0} 0.45 &amp; 0.66 &amp; 0.52 \\
Mixtral 8x7B &amp; 0.07 &amp; \cellcolor{cyan!16.2} 0.25 &amp; 0.57 &amp; \cellcolor{cyan!2.4} 0.58 &amp; 0.28 &amp; 0.32 &amp; 0.60 &amp; \cellcolor{orange!25.0} 0.44 \\
Yi 34B (it) &amp; \cellcolor{cyan!3.7} 0.06 &amp; \cellcolor{cyan!11.2} 0.25 &amp; 0.50 &amp; \cellcolor{orange!25.0} 0.44 &amp; 0.35 &amp; 0.36 &amp; 0.65 &amp; 0.56 \\
Yi 34B &amp; 0.14 &amp; 0.27 &amp; 0.53 &amp; \cellcolor{orange!25.0} 0.44 &amp; \cellcolor{cyan!4.5} 0.08 &amp; \cellcolor{cyan!25.0} 0.24 &amp; 0.62 &amp; 0.56 \\
Llama 3 8B (it) &amp; 0.11 &amp; \cellcolor{cyan!12.4} 0.25 &amp; 0.56 &amp; 0.56 &amp; 0.19 &amp; 0.28 &amp; 0.60 &amp; 0.57 \\
Llama 3 8B &amp; 0.12 &amp; 0.26 &amp; \cellcolor{orange!25.0} 0.48 &amp; \cellcolor{orange!25.0} 0.44 &amp; 0.08 &amp; \cellcolor{cyan!7.1} 0.25 &amp; 0.53 &amp; 0.56 \\
Mistral 7B (it) &amp; 0.11 &amp; \cellcolor{cyan!11.2} 0.25 &amp; 0.55 &amp; 0.56 &amp; \cellcolor{orange!2.7} 0.41 &amp; 0.42 &amp; 0.59 &amp; 0.57 \\
Gemma 7B (it) &amp; 0.10 &amp; \cellcolor{cyan!4.9} 0.26 &amp; \cellcolor{orange!4.9} 0.49 &amp; \cellcolor{orange!25.0} 0.44 &amp; \cellcolor{orange!12.0} 0.42 &amp; 0.43 &amp; 0.53 &amp; 0.56 \\
Mistral 7B &amp; \cellcolor{orange!25.0} 0.44 &amp; \cellcolor{orange!25.0} 0.44 &amp; 0.50 &amp; 0.56 &amp; \cellcolor{cyan!22.5} 0.05 &amp; \cellcolor{cyan!14.2} 0.25 &amp; 0.57 &amp; 0.56 \\
Gemma 7B &amp; \cellcolor{cyan!25.0} 0.03 &amp; \cellcolor{cyan!13.7} 0.25 &amp; 0.52 &amp; 0.55 &amp; \cellcolor{cyan!25.0} 0.04 &amp; \cellcolor{cyan!19.0} 0.24 &amp; 0.61 &amp; 0.58 \\
Gemma 2B (it) &amp; 0.19 &amp; 0.28 &amp; 0.50 &amp; 0.56 &amp; 0.34 &amp; 0.36 &amp; \cellcolor{orange!9.3} 0.49 &amp; 0.56 \\
Gemma 2B &amp; \cellcolor{orange!25.0} 0.44 &amp; \cellcolor{orange!25.0} 0.44 &amp; 0.50 &amp; 0.56 &amp; 0.09 &amp; \cellcolor{cyan!4.7} 0.26 &amp; \cellcolor{orange!25.0} 0.48 &amp; \cellcolor{orange!25.0} 0.44 \\
LR &amp; 0.04 &amp; 0.24 &amp; 0.58 &amp; 0.56 &amp; 0.04 &amp; 0.24 &amp; 0.58 &amp; 0.56 \\
GBM &amp; 0.02 &amp; 0.20 &amp; 0.75 &amp; 0.69 &amp; 0.02 &amp; 0.20 &amp; 0.75 &amp; 0.69 \\
XGBoost &amp; 0.02 &amp; 0.19 &amp; 0.77 &amp; 0.70 &amp; 0.02 &amp; 0.19 &amp; 0.77 &amp; 0.70 \\
\bottomrule
\end{tabular}


*** ACSPUBLICCOVERAGE ***

\begin{tabular}{lllllllll}
\toprule
 &amp; ece (num) &amp; brier score loss (num) &amp; roc auc (num) &amp; accuracy (num) &amp; ece &amp; brier score loss &amp; roc auc &amp; accuracy \\
Model &amp;  &amp;  &amp;  &amp;  &amp;  &amp;  &amp;  &amp;  \\
\midrule
GPT 4o mini (it) &amp; 0.10 &amp; 0.20 &amp; 0.68 &amp; \cellcolor{cyan!17.6} 0.73 &amp; 0.33 &amp; 0.34 &amp; \cellcolor{cyan!25.0} 0.71 &amp; 0.60 \\
Mixtral 8x22B (it) &amp; \cellcolor{cyan!25.0} 0.04 &amp; \cellcolor{cyan!25.0} 0.18 &amp; \cellcolor{cyan!11.0} 0.71 &amp; \cellcolor{cyan!25.0} 0.75 &amp; 0.24 &amp; 0.25 &amp; \cellcolor{cyan!11.7} 0.70 &amp; \cellcolor{cyan!12.7} 0.72 \\
Mixtral 8x22B &amp; \cellcolor{orange!15.5} 0.29 &amp; \cellcolor{orange!3.4} 0.29 &amp; 0.54 &amp; \cellcolor{cyan!0.5} 0.70 &amp; 0.32 &amp; 0.30 &amp; 0.59 &amp; \cellcolor{orange!25.0} 0.30 \\
Llama 3 70B (it) &amp; 0.13 &amp; 0.20 &amp; \cellcolor{cyan!25.0} 0.73 &amp; \cellcolor{cyan!24.4} 0.75 &amp; 0.16 &amp; \cellcolor{cyan!16.2} 0.21 &amp; \cellcolor{cyan!7.0} 0.69 &amp; \cellcolor{cyan!25.0} 0.75 \\
Llama 3 70B &amp; 0.12 &amp; 0.21 &amp; 0.64 &amp; 0.53 &amp; 0.18 &amp; \cellcolor{cyan!8.3} 0.22 &amp; 0.67 &amp; 0.63 \\
Mixtral 8x7B (it) &amp; \cellcolor{cyan!0.3} 0.06 &amp; \cellcolor{cyan!18.5} 0.19 &amp; 0.69 &amp; \cellcolor{cyan!22.2} 0.74 &amp; 0.20 &amp; \cellcolor{cyan!7.4} 0.23 &amp; \cellcolor{cyan!12.7} 0.70 &amp; \cellcolor{cyan!23.3} 0.74 \\
Mixtral 8x7B &amp; 0.20 &amp; 0.25 &amp; 0.56 &amp; 0.70 &amp; 0.41 &amp; 0.37 &amp; 0.57 &amp; \cellcolor{orange!25.0} 0.30 \\
Yi 34B (it) &amp; 0.22 &amp; 0.24 &amp; 0.57 &amp; \cellcolor{orange!25.0} 0.31 &amp; \cellcolor{cyan!16.7} 0.06 &amp; \cellcolor{cyan!25.0} 0.19 &amp; 0.67 &amp; \cellcolor{cyan!19.4} 0.74 \\
Yi 34B &amp; 0.09 &amp; 0.20 &amp; 0.67 &amp; 0.64 &amp; \cellcolor{cyan!25.0} 0.04 &amp; \cellcolor{cyan!17.2} 0.21 &amp; 0.59 &amp; \cellcolor{cyan!2.1} 0.70 \\
Llama 3 8B (it) &amp; 0.17 &amp; 0.22 &amp; 0.64 &amp; 0.68 &amp; 0.11 &amp; \cellcolor{cyan!12.7} 0.21 &amp; 0.59 &amp; \cellcolor{cyan!7.7} 0.71 \\
Llama 3 8B &amp; 0.20 &amp; 0.25 &amp; 0.51 &amp; \cellcolor{orange!6.2} 0.34 &amp; 0.41 &amp; 0.38 &amp; 0.55 &amp; \cellcolor{orange!25.0} 0.30 \\
Mistral 7B (it) &amp; 0.07 &amp; 0.20 &amp; 0.67 &amp; 0.65 &amp; 0.30 &amp; 0.30 &amp; 0.61 &amp; \cellcolor{cyan!0.4} 0.70 \\
Gemma 7B (it) &amp; 0.18 &amp; 0.24 &amp; 0.57 &amp; 0.61 &amp; 0.30 &amp; 0.34 &amp; \cellcolor{orange!14.6} 0.46 &amp; 0.50 \\
Mistral 7B &amp; \cellcolor{orange!22.1} 0.30 &amp; \cellcolor{orange!18.5} 0.30 &amp; 0.50 &amp; 0.70 &amp; 0.29 &amp; 0.30 &amp; \cellcolor{orange!25.0} 0.45 &amp; \cellcolor{orange!25.0} 0.30 \\
Gemma 7B &amp; 0.18 &amp; 0.26 &amp; 0.48 &amp; 0.70 &amp; 0.15 &amp; \cellcolor{cyan!3.4} 0.23 &amp; 0.49 &amp; 0.49 \\
Gemma 2B (it) &amp; 0.24 &amp; \cellcolor{orange!14.2} 0.29 &amp; \cellcolor{orange!25.0} 0.42 &amp; 0.42 &amp; \cellcolor{orange!25.0} 0.70 &amp; \cellcolor{orange!25.0} 0.70 &amp; 0.54 &amp; \cellcolor{orange!25.0} 0.30 \\
Gemma 2B &amp; \cellcolor{orange!25.0} 0.30 &amp; \cellcolor{orange!25.0} 0.30 &amp; 0.50 &amp; 0.70 &amp; 0.26 &amp; 0.28 &amp; 0.54 &amp; \cellcolor{orange!25.0} 0.30 \\
LR &amp; 0.03 &amp; 0.19 &amp; 0.70 &amp; 0.72 &amp; 0.03 &amp; 0.19 &amp; 0.70 &amp; 0.72 \\
GBM &amp; 0.01 &amp; 0.14 &amp; 0.83 &amp; 0.80 &amp; 0.01 &amp; 0.14 &amp; 0.83 &amp; 0.80 \\
XGBoost &amp; 0.00 &amp; 0.14 &amp; 0.84 &amp; 0.80 &amp; 0.00 &amp; 0.14 &amp; 0.84 &amp; 0.80 \\
\bottomrule
\end{tabular}


</pre></div></div>
</div>
</section>
<section id="Render-paper-plots">
<h2>Render paper plots<a class="headerlink" href="#Render-paper-plots" title="Link to this heading"></a></h2>
<p>Filter by the currently selected prompting scheme:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">all_results_df_original</span> <span class="o">=</span> <span class="n">all_results_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="n">all_results_df</span> <span class="o">=</span> <span class="n">all_results_df</span><span class="p">[</span>
    <span class="p">(</span><span class="n">all_results_df</span><span class="p">[</span><span class="n">numeric_prompt_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">NUMERIC_PROMPTING</span><span class="p">)</span>
    <span class="o">|</span> <span class="p">(</span><span class="n">all_results_df</span><span class="p">[</span><span class="n">numeric_prompt_col</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">())</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set_style</span><span class="p">(</span><span class="s2">&quot;whitegrid&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;grid.linestyle&quot;</span><span class="p">:</span> <span class="s2">&quot;--&quot;</span><span class="p">})</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s2">&quot;figure&quot;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">4.5</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>

<span class="n">palette_name</span> <span class="o">=</span> <span class="s2">&quot;tab10&quot;</span>   <span class="c1"># &quot;colorblind&quot;</span>
<span class="n">palette</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="n">palette_name</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set_palette</span><span class="p">(</span><span class="n">palette_name</span><span class="p">)</span>
<span class="n">palette</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<svg  width="550" height="55"><rect x="0" y="0" width="55" height="55" style="fill:#1f77b4;stroke-width:2;stroke:rgb(255,255,255)"/><rect x="55" y="0" width="55" height="55" style="fill:#ff7f0e;stroke-width:2;stroke:rgb(255,255,255)"/><rect x="110" y="0" width="55" height="55" style="fill:#2ca02c;stroke-width:2;stroke:rgb(255,255,255)"/><rect x="165" y="0" width="55" height="55" style="fill:#d62728;stroke-width:2;stroke:rgb(255,255,255)"/><rect x="220" y="0" width="55" height="55" style="fill:#9467bd;stroke-width:2;stroke:rgb(255,255,255)"/><rect x="275" y="0" width="55" height="55" style="fill:#8c564b;stroke-width:2;stroke:rgb(255,255,255)"/><rect x="330" y="0" width="55" height="55" style="fill:#e377c2;stroke-width:2;stroke:rgb(255,255,255)"/><rect x="385" y="0" width="55" height="55" style="fill:#7f7f7f;stroke-width:2;stroke:rgb(255,255,255)"/><rect x="440" y="0" width="55" height="55" style="fill:#bcbd22;stroke-width:2;stroke:rgb(255,255,255)"/><rect x="495" y="0" width="55" height="55" style="fill:#17becf;stroke-width:2;stroke:rgb(255,255,255)"/></svg></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">IMGS_DIR</span> <span class="o">=</span> <span class="n">ACS_AGG_RESULTS_PATH</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;imgs&quot;</span>
<span class="n">IMGS_DIR</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">save_fig</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">add_prompt_suffix</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">num_or_multiple_choice</span> <span class="o">=</span> <span class="s2">&quot;numeric-prompt&quot;</span> <span class="k">if</span> <span class="n">NUMERIC_PROMPTING</span> <span class="k">else</span> <span class="s2">&quot;multiple-choice-prompt&quot;</span>
    <span class="n">save_path</span> <span class="o">=</span> <span class="p">(</span><span class="n">IMGS_DIR</span> <span class="o">/</span> <span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.pdf&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">add_prompt_suffix</span><span class="p">:</span>
        <span class="n">save_path</span> <span class="o">=</span> <span class="n">save_path</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;.</span><span class="si">{</span><span class="n">num_or_multiple_choice</span><span class="si">}</span><span class="s2">.pdf&quot;</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved figure to &#39;</span><span class="si">{</span><span class="n">save_path</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Load scores distributions for each model (and with varying degrees of information).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">predictions_path_col</span> <span class="o">=</span> <span class="s2">&quot;predictions_path&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">load_model_scores_df</span><span class="p">(</span><span class="n">df_row</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Loads csv containing model scores corresponding to the given DF row.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">predictions_path_col</span> <span class="ow">in</span> <span class="n">df_row</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">df_row</span><span class="p">[</span><span class="n">predictions_path_col</span><span class="p">]):</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">df_row</span><span class="p">[</span><span class="n">predictions_path_col</span><span class="p">],</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scores_df_map</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">id_</span><span class="p">:</span> <span class="n">load_model_scores_df</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">id_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">all_results_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">(),</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">all_results_df</span><span class="p">))</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "465640a48d654dd3999164c4cc8efc3f", "version_major": 2, "version_minor": 0}</script></div>
</div>
<section id="1st-page-illustrative-plot">
<h3>1st page illustrative plot<a class="headerlink" href="#1st-page-illustrative-plot" title="Link to this heading"></a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">example_task</span> <span class="o">=</span> <span class="s2">&quot;ACSIncome&quot;</span>

<span class="c1"># example_model = &quot;Mistral-7B-v0.1&quot;</span>
<span class="n">example_model</span> <span class="o">=</span> <span class="s2">&quot;Meta-Llama-3-70B&quot;</span>

<span class="n">baseline_model</span> <span class="o">=</span> <span class="s2">&quot;XGBoost&quot;</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Data for baseline model</span>
<span class="n">baseline_row</span> <span class="o">=</span> <span class="n">all_results_df</span><span class="p">[(</span><span class="n">all_results_df</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">baseline_model</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">all_results_df</span><span class="p">[</span><span class="n">task_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">example_task</span><span class="p">)]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># Data for base and instruct models</span>
<span class="n">example_df</span> <span class="o">=</span> <span class="n">all_results_df</span><span class="p">[</span>
    <span class="p">(</span><span class="n">all_results_df</span><span class="p">[</span><span class="n">task_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">example_task</span><span class="p">)</span>
    <span class="o">&amp;</span> <span class="p">(</span><span class="n">all_results_df</span><span class="p">[</span><span class="s2">&quot;base_name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">example_model</span><span class="p">)</span>
    <span class="o">&amp;</span> <span class="p">(</span><span class="n">all_results_df</span><span class="p">[</span><span class="n">numeric_prompt_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">NUMERIC_PROMPTING</span><span class="p">)</span>
<span class="p">]</span>

<span class="c1"># Sort examples_df to have (base, instruct) ordering</span>
<span class="n">example_df</span> <span class="o">=</span> <span class="n">example_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;is_inst&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">example_df</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>accuracy</th>
      <th>accuracy_diff</th>
      <th>accuracy_ratio</th>
      <th>balanced_accuracy</th>
      <th>balanced_accuracy_diff</th>
      <th>balanced_accuracy_ratio</th>
      <th>brier_score_loss</th>
      <th>ece</th>
      <th>ece_quantile</th>
      <th>equalized_odds_diff</th>
      <th>...</th>
      <th>num_features</th>
      <th>uses_all_features</th>
      <th>fit_thresh_on_100</th>
      <th>fit_thresh_accuracy</th>
      <th>optimal_thresh</th>
      <th>optimal_thresh_accuracy</th>
      <th>score_stdev</th>
      <th>score_mean</th>
      <th>model_size</th>
      <th>model_family</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Meta-Llama-3-70B__ACSIncome__-1__Num</th>
      <td>0.543953</td>
      <td>0.134809</td>
      <td>0.771466</td>
      <td>0.636284</td>
      <td>0.078752</td>
      <td>0.887756</td>
      <td>0.237630</td>
      <td>0.270157</td>
      <td>NaN</td>
      <td>0.191080</td>
      <td>...</td>
      <td>-1</td>
      <td>True</td>
      <td>0.89560</td>
      <td>0.784722</td>
      <td>0.8956</td>
      <td>0.784722</td>
      <td>0.253299</td>
      <td>0.638033</td>
      <td>70</td>
      <td>Llama</td>
    </tr>
    <tr>
      <th>Meta-Llama-3-70B-Instruct__ACSIncome__-1__Num</th>
      <td>0.665731</td>
      <td>0.086680</td>
      <td>0.880953</td>
      <td>0.722658</td>
      <td>0.061832</td>
      <td>0.919317</td>
      <td>0.230512</td>
      <td>0.246092</td>
      <td>NaN</td>
      <td>0.232483</td>
      <td>...</td>
      <td>-1</td>
      <td>True</td>
      <td>0.75718</td>
      <td>0.735764</td>
      <td>0.8239</td>
      <td>0.784848</td>
      <td>0.290286</td>
      <td>0.613968</td>
      <td>70</td>
      <td>Llama</td>
    </tr>
  </tbody>
</table>
<p>2 rows × 66 columns</p>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ALPHA</span> <span class="o">=</span> <span class="mf">0.7</span>
<span class="n">N_BINS</span> <span class="o">=</span> <span class="mi">20</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">ax3</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">),</span> <span class="n">gridspec_kw</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.4</span><span class="p">))</span>

<span class="c1">###</span>
<span class="c1"># ROC barplot</span>
<span class="c1">###</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span>
    <span class="n">data</span><span class="o">=</span><span class="n">example_df</span><span class="p">,</span>
    <span class="n">x</span><span class="o">=</span><span class="s2">&quot;is_inst&quot;</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="s2">&quot;roc_auc&quot;</span><span class="p">,</span>
    <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="n">ALPHA</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Add horizontal line and label</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">baseline_row</span><span class="p">[</span><span class="s2">&quot;roc_auc&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">baseline_model</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">xmin</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="mf">0.95</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="mf">1.15</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="n">baseline_row</span><span class="p">[</span><span class="s2">&quot;roc_auc&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1e-3</span><span class="p">,</span>
    <span class="n">s</span><span class="o">=</span><span class="n">baseline_model</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
    <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span>
    <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
    <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span>
    <span class="n">backgroundcolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span>
    <span class="n">zorder</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">baseline_row</span><span class="p">[</span><span class="s2">&quot;roc_auc&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">9e-2</span><span class="p">)</span>
<span class="c1"># ax1.set_ylim(0.5, baseline_row[&quot;roc_auc&quot;] + 7e-2)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;ROC AUC&quot;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>   <span class="c1"># Remove the legend</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s2">&quot;Base&quot;</span><span class="p">,</span> <span class="s2">&quot;Instr.&quot;</span><span class="p">])</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Predictive signal&quot;</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;$\uparrow$&quot;</span><span class="p">)</span>

<span class="c1">###</span>
<span class="c1"># Score distribution</span>
<span class="c1">###</span>
<span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram_bin_edges</span><span class="p">([],</span> <span class="n">bins</span><span class="o">=</span><span class="n">N_BINS</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="k">for</span> <span class="n">id_</span> <span class="ow">in</span> <span class="n">example_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span>
        <span class="n">scores_df_map</span><span class="p">[</span><span class="n">id_</span><span class="p">][</span><span class="s2">&quot;risk_score&quot;</span><span class="p">],</span>
        <span class="n">alpha</span><span class="o">=</span><span class="n">ALPHA</span> <span class="o">*</span> <span class="mf">0.9</span><span class="p">,</span>
        <span class="n">stat</span><span class="o">=</span><span class="s2">&quot;proportion&quot;</span><span class="p">,</span>
        <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span>
        <span class="n">zorder</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
        <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">,</span>
    <span class="p">)</span>

<span class="c1"># # Draw baseline score distribution</span>
<span class="c1"># sns.histplot(</span>
<span class="c1">#     scores_df_map[baseline_row.name][&quot;risk_score&quot;],</span>
<span class="c1">#     alpha=1,</span>
<span class="c1">#     bins=bins,</span>
<span class="c1">#     stat=&quot;proportion&quot;,</span>
<span class="c1">#     fill=False,</span>
<span class="c1">#     color=palette[2],</span>
<span class="c1">#     edgecolor=palette[2],</span>
<span class="c1">#     hatch=&quot;/&quot;,</span>
<span class="c1">#     zorder=-1,</span>
<span class="c1">#     ax=ax2,</span>
<span class="c1"># )</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Score distribution&quot;</span><span class="p">)</span>

<span class="c1">###</span>
<span class="c1"># Calibration error</span>
<span class="c1">###</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span>
    <span class="n">data</span><span class="o">=</span><span class="n">example_df</span><span class="p">,</span>
    <span class="n">x</span><span class="o">=</span><span class="s2">&quot;is_inst&quot;</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="s2">&quot;ece&quot;</span><span class="p">,</span>
    <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="n">ALPHA</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">ax3</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Add horizontal line and label</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">baseline_row</span><span class="p">[</span><span class="s2">&quot;ece&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">baseline_model</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">xmin</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="mf">0.95</span><span class="p">)</span>

<span class="n">ax3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;ECE&quot;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s2">&quot;Base&quot;</span><span class="p">,</span> <span class="s2">&quot;Instr.&quot;</span><span class="p">])</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Calibration error&quot;</span> <span class="o">+</span> <span class="s2">&quot;$\downarrow$&quot;</span><span class="p">)</span>
<span class="c1"># ax3.legend(</span>
<span class="c1">#     loc=&quot;center left&quot;,</span>
<span class="c1">#     bbox_to_anchor=(1.05, 0.5),</span>
<span class="c1"># )</span>

<span class="n">hs</span><span class="p">,</span> <span class="n">ls</span> <span class="o">=</span> <span class="n">ax3</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">hs</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">labels</span><span class="o">=</span><span class="n">ls</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper center&quot;</span><span class="p">)</span>

<span class="n">save_fig</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;teaser-</span><span class="si">{</span><span class="n">example_model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/tmp/ipykernel_3388197/4070898515.py:38: UserWarning: set_ticklabels() should only be used with a fixed number of ticks, i.e. after set_ticks() or using a FixedLocator.
  ax1.set_xticklabels([&#34;Base&#34;, &#34;Instr.&#34;])
/tmp/ipykernel_3388197/4070898515.py:90: UserWarning: set_ticklabels() should only be used with a fixed number of ticks, i.e. after set_ticks() or using a FixedLocator.
  ax3.set_xticklabels([&#34;Base&#34;, &#34;Instr.&#34;])
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Saved figure to &#39;../results/imgs/teaser-Meta-Llama-3-70B.numeric-prompt.pdf&#39;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_paper-plots-and-tables_41_2.png" src="../_images/notebooks_paper-plots-and-tables_41_2.png" />
</div>
</div>
</section>
<section id="Score-distributions-for-base/instruct-pairs">
<h3>Score distributions for base/instruct pairs<a class="headerlink" href="#Score-distributions-for-base/instruct-pairs" title="Link to this heading"></a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Plotting score distributions for the following task: </span><span class="si">{</span><span class="n">example_task</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

<span class="n">task_df</span> <span class="o">=</span> <span class="n">all_results_df</span><span class="p">[</span>
    <span class="p">(</span><span class="n">all_results_df</span><span class="p">[</span><span class="n">task_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">example_task</span><span class="p">)</span>
    <span class="o">&amp;</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">all_results_df</span><span class="p">[</span><span class="n">numeric_prompt_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">NUMERIC_PROMPTING</span><span class="p">)</span>
        <span class="o">|</span> <span class="p">(</span><span class="n">all_results_df</span><span class="p">[</span><span class="n">numeric_prompt_col</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">())</span>                  <span class="c1"># Baseline models will have NaNs in this col.</span>
    <span class="p">)]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">task_df</span><span class="p">)</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Plotting score distributions for the following task: ACSIncome.
len(task_df)=20
</pre></div></div>
</div>
<p>Sort model pairs as wished for the paper plot:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sorted_model_families</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;OpenAI&quot;</span><span class="p">,</span> <span class="s2">&quot;Llama&quot;</span><span class="p">,</span> <span class="s2">&quot;Mistral&quot;</span><span class="p">,</span> <span class="s2">&quot;Yi&quot;</span><span class="p">,</span> <span class="s2">&quot;Gemma&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">]</span>

<span class="n">model_pairs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span>
        <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;base_name&quot;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="n">model_col</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">id_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">task_df</span><span class="p">[</span><span class="n">task_df</span><span class="p">[</span><span class="s2">&quot;is_inst&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">]</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()</span>
    <span class="p">],</span>
    <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> <span class="p">(</span>
        <span class="mf">1e6</span> <span class="o">*</span> <span class="n">sorted_model_families</span><span class="o">.</span><span class="n">index</span><span class="p">((</span><span class="n">row</span> <span class="o">:=</span> <span class="n">task_df</span><span class="p">[</span><span class="n">task_df</span><span class="p">[</span><span class="n">model_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="s2">&quot;model_family&quot;</span><span class="p">])</span>
        <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;model_size&quot;</span><span class="p">]</span>
    <span class="p">)</span>
<span class="p">)</span>
<span class="n">model_pairs</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[(&#39;penai/gpt-4o-mini&#39;, &#39;penai/gpt-4o-mini&#39;),
 (&#39;Meta-Llama-3-8B&#39;, &#39;Meta-Llama-3-8B-Instruct&#39;),
 (&#39;Meta-Llama-3-70B&#39;, &#39;Meta-Llama-3-70B-Instruct&#39;),
 (&#39;Mistral-7B-v0.1&#39;, &#39;Mistral-7B-Instruct-v0.2&#39;),
 (&#39;Mixtral-8x7B-v0.1&#39;, &#39;Mixtral-8x7B-Instruct-v0.1&#39;),
 (&#39;Mixtral-8x22B-v0.1&#39;, &#39;Mixtral-8x22B-Instruct-v0.1&#39;),
 (&#39;Yi-34B&#39;, &#39;Yi-34B-Chat&#39;),
 (&#39;gemma-2b&#39;, &#39;gemma-1.1-2b-it&#39;),
 (&#39;gemma-7b&#39;, &#39;gemma-1.1-7b-it&#39;)]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">PLOT_THRESHOLD_LINE</span> <span class="o">=</span> <span class="kc">False</span>

<span class="n">N_PLOTS</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_pairs</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># plus 1 for the XGBoost baseline</span>

<span class="n">N_COLS</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">N_ROWS</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">N_PLOTS</span> <span class="o">/</span> <span class="n">N_COLS</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
    <span class="n">nrows</span><span class="o">=</span><span class="n">N_ROWS</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">N_COLS</span><span class="p">,</span>
    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">N_ROWS</span><span class="p">),</span>
    <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">gridspec_kw</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
        <span class="n">hspace</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="n">wspace</span><span class="o">=</span><span class="mf">0.06</span><span class="p">,</span>
    <span class="p">),</span>
<span class="p">)</span>

<span class="c1"># Plot settings</span>
<span class="n">plot_config</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">bins</span><span class="o">=</span><span class="n">N_BINS</span><span class="p">,</span>
    <span class="n">binrange</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="n">stat</span><span class="o">=</span><span class="s2">&quot;percent&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Plot score distribution for model pairs</span>
<span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">base_name</span><span class="p">,</span> <span class="n">instr_name</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">model_pairs</span><span class="p">):</span>
    <span class="n">ax_row</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">//</span> <span class="n">N_COLS</span>
    <span class="n">ax_col</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">%</span> <span class="n">N_COLS</span>

    <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">ax_row</span><span class="p">,</span> <span class="n">ax_col</span><span class="p">]</span>
    <span class="n">base_row</span> <span class="o">=</span> <span class="n">task_df</span><span class="p">[</span><span class="n">task_df</span><span class="p">[</span><span class="n">model_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">base_name</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">it_row</span> <span class="o">=</span> <span class="n">task_df</span><span class="p">[</span><span class="n">task_df</span><span class="p">[</span><span class="n">model_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">instr_name</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Get scores</span>
    <span class="n">base_scores</span> <span class="o">=</span> <span class="n">scores_df_map</span><span class="p">[</span><span class="n">base_row</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;risk_score&quot;</span><span class="p">]</span>
    <span class="n">it_scores</span> <span class="o">=</span> <span class="n">scores_df_map</span><span class="p">[</span><span class="n">it_row</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;risk_score&quot;</span><span class="p">]</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">base_row</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;risk scores&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ax_col</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;density (%)&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ax_row</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">70</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.03</span><span class="p">,</span> <span class="mf">1.03</span><span class="p">)</span>

    <span class="c1"># Render plot</span>
    <span class="k">if</span> <span class="s2">&quot;gpt&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">instr_name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">base_scores</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Base&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">palette</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="o">**</span><span class="n">plot_config</span><span class="p">)</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">it_scores</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Instruction-tuned&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">palette</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="o">**</span><span class="n">plot_config</span><span class="p">)</span>

    <span class="c1"># Draw faint vertical line with t^* of each model</span>
    <span class="n">threshold_col</span> <span class="o">=</span> <span class="s2">&quot;optimal_thresh&quot;</span>
    <span class="c1"># threshold_col = &quot;fit_thresh_on_100&quot;</span>

    <span class="k">if</span> <span class="n">PLOT_THRESHOLD_LINE</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">base_row</span><span class="p">[</span><span class="n">threshold_col</span><span class="p">],</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">palette</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">it_row</span><span class="p">[</span><span class="n">threshold_col</span><span class="p">],</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">palette</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="c1"># Render legend on a few sub-plots</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ax_col</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">ax_row</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">ax_col</span> <span class="o">==</span> <span class="n">N_COLS</span><span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">ax_row</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper center&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">PLOT_THRESHOLD_LINE</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="n">base_row</span><span class="p">[</span><span class="n">threshold_col</span><span class="p">]</span> <span class="o">-</span> <span class="mf">5e-2</span><span class="p">,</span>
                <span class="n">y</span><span class="o">=</span><span class="mi">43</span><span class="p">,</span>
                <span class="n">s</span><span class="o">=</span><span class="s2">&quot;$t^*$&quot;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="n">palette</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
                <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span>
                <span class="c1"># zorder=-1,</span>
            <span class="p">)</span> <span class="c1">#.set_bbox(dict(facecolor=&#39;white&#39;, alpha=0.5))</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="n">it_row</span><span class="p">[</span><span class="n">threshold_col</span><span class="p">]</span> <span class="o">+</span> <span class="mf">5e-2</span><span class="p">,</span>
                <span class="n">y</span><span class="o">=</span><span class="mi">43</span><span class="p">,</span>
                <span class="n">s</span><span class="o">=</span><span class="s2">&quot;$t^*$&quot;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="n">palette</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
                <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span>
                <span class="c1"># zorder=-1,</span>
            <span class="p">)</span>


<span class="c1"># Plot score distribution for XGBoost baseline</span>
<span class="n">baseline_name</span> <span class="o">=</span> <span class="s2">&quot;XGBoost&quot;</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">baseline_name</span><span class="p">)</span>

<span class="n">baseline_row</span> <span class="o">=</span> <span class="n">task_df</span><span class="p">[</span><span class="n">task_df</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">baseline_name</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">xgboost_scores</span> <span class="o">=</span> <span class="n">scores_df_map</span><span class="p">[</span><span class="n">baseline_row</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;risk_score&quot;</span><span class="p">]</span>

<span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span>
    <span class="n">xgboost_scores</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="n">baseline_name</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="n">palette</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
    <span class="o">**</span><span class="n">plot_config</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;risk scores&quot;</span><span class="p">)</span>

<span class="c1"># # Remove unused plot?</span>
<span class="c1"># axes[1, 3].remove()</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;density (%)&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">60</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">60</span><span class="p">])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>

<span class="c1"># Save figure</span>
<span class="n">save_fig</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;score-distribution&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;_with-threshold&quot;</span> <span class="k">if</span> <span class="n">PLOT_THRESHOLD_LINE</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Saved figure to &#39;../results/imgs/score-distribution.numeric-prompt.pdf&#39;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_paper-plots-and-tables_46_1.png" src="../_images/notebooks_paper-plots-and-tables_46_1.png" />
</div>
</div>
</section>
</section>
<section id="Calibration-curves">
<h2>Calibration curves<a class="headerlink" href="#Calibration-curves" title="Link to this heading"></a></h2>
<p>Base models vs Instruction-tuned models:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">TASK</span> <span class="o">=</span> <span class="s2">&quot;ACSIncome&quot;</span>

<span class="c1"># df = results_df[(results_df[task_col] == TASK) &amp; (results_df[numeric_prompt_col] == NUMERIC_PROMPTING)]</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">all_results_df</span><span class="p">[(</span><span class="n">all_results_df</span><span class="p">[</span><span class="n">task_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">TASK</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">all_results_df</span><span class="p">[</span><span class="n">numeric_prompt_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">NUMERIC_PROMPTING</span><span class="p">)]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
len(df)=17
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.calibration</span><span class="w"> </span><span class="kn">import</span> <span class="n">CalibrationDisplay</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">prettify_model_name</span>

<span class="n">base_models_to_plot</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;base_name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span> <span class="k">if</span> <span class="s2">&quot;gemma&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>

<span class="n">base_models_to_plot</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;Meta-Llama-3-8B&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Meta-Llama-3-70B&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Mistral-7B-v0.1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Mixtral-8x7B-v0.1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Mixtral-8x22B-v0.1&quot;</span><span class="p">,</span>
    <span class="c1"># &quot;Yi-34B&quot;,</span>
<span class="p">]</span>

<span class="n">instr_models_to_plot</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">df</span><span class="p">[</span>
        <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;base_name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">m</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">model_col</span><span class="p">]</span> <span class="o">!=</span> <span class="n">m</span><span class="p">)</span>
    <span class="p">][</span><span class="n">model_col</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">base_models_to_plot</span>
<span class="p">]</span>

<span class="c1"># Add GPT models if any</span>
<span class="n">instr_models_to_plot</span> <span class="o">+=</span> <span class="p">[</span><span class="n">m</span><span class="p">[</span><span class="n">model_col</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()</span> <span class="k">if</span> <span class="s2">&quot;gpt&quot;</span> <span class="ow">in</span> <span class="n">m</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">gridspec_kw</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.33</span><span class="p">),</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Plot base models</span>
<span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">model_list</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="p">(</span><span class="n">base_models_to_plot</span><span class="p">,</span> <span class="n">instr_models_to_plot</span><span class="p">)):</span>

    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">model_list</span><span class="p">):</span>

        <span class="n">curr_row</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">model_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">m</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">curr_scores</span> <span class="o">=</span> <span class="n">scores_df_map</span><span class="p">[</span><span class="n">curr_row</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>

        <span class="n">disp</span> <span class="o">=</span> <span class="n">CalibrationDisplay</span><span class="o">.</span><span class="n">from_predictions</span><span class="p">(</span>
            <span class="n">y_true</span><span class="o">=</span><span class="n">curr_scores</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">],</span>
            <span class="n">y_prob</span><span class="o">=</span><span class="n">curr_scores</span><span class="p">[</span><span class="s2">&quot;risk_score&quot;</span><span class="p">],</span>
            <span class="n">n_bins</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
            <span class="n">strategy</span><span class="o">=</span><span class="s2">&quot;quantile&quot;</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">prettify_model_name</span><span class="p">(</span><span class="n">curr_row</span><span class="p">[</span><span class="s2">&quot;base_name&quot;</span><span class="p">]),</span>
            <span class="n">linestyle</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;-.&quot;</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot;--&quot;</span><span class="p">][</span><span class="n">idx</span> <span class="o">%</span> <span class="mi">3</span><span class="p">],</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">ylabel</span> <span class="o">=</span> <span class="s2">&quot;Fraction of positives &quot;</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;$\left(\mathrm</span><span class="si">{P}</span><span class="s2">[Y=1]\right)$&quot;</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>

<span class="n">xlabel</span> <span class="o">=</span> <span class="s2">&quot;Mean predicted probability&quot;</span> <span class="c1"># + r&quot; $(\mathbb{E}[R])$&quot;</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Base models&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Instruction-tuned models&quot;</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>

<span class="c1"># Legent to the right of the right-most plot</span>
<span class="n">h</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
<span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Perf. calibrated&quot;</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">h</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">l</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">))</span>


<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>

<span class="n">save_fig</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;calibration-curves-base-and-instr.pdf&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Saved figure to &#39;../results/imgs/calibration-curves-base-and-instr.numeric-prompt.pdf&#39;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_paper-plots-and-tables_50_1.png" src="../_images/notebooks_paper-plots-and-tables_50_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.calibration</span><span class="w"> </span><span class="kn">import</span> <span class="n">CalibrationDisplay</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">prettify_model_name</span>

<span class="n">base_models_to_plot</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;base_name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span> <span class="k">if</span> <span class="s2">&quot;gemma&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>

<span class="n">base_models_to_plot</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;Meta-Llama-3-70B&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Mixtral-8x7B-v0.1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Mixtral-8x22B-v0.1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Yi-34B&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">instr_models_to_plot</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">df</span><span class="p">[</span>
        <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;base_name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">m</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">model_col</span><span class="p">]</span> <span class="o">!=</span> <span class="n">m</span><span class="p">)</span>
    <span class="p">][</span><span class="n">model_col</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">base_models_to_plot</span>
<span class="p">]</span>

<span class="c1"># Add GPT models if any</span>
<span class="n">instr_models_to_plot</span> <span class="o">+=</span> <span class="p">[</span><span class="n">m</span><span class="p">[</span><span class="n">model_col</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()</span> <span class="k">if</span> <span class="s2">&quot;gpt&quot;</span> <span class="ow">in</span> <span class="n">m</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">gridspec_kw</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.33</span><span class="p">),</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Plot base models</span>
<span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">model_list</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="p">(</span><span class="n">base_models_to_plot</span><span class="p">,</span> <span class="n">instr_models_to_plot</span><span class="p">)):</span>

    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">model_list</span><span class="p">):</span>

        <span class="n">curr_row</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">model_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">m</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">curr_scores</span> <span class="o">=</span> <span class="n">scores_df_map</span><span class="p">[</span><span class="n">curr_row</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>

        <span class="n">disp</span> <span class="o">=</span> <span class="n">CalibrationDisplay</span><span class="o">.</span><span class="n">from_predictions</span><span class="p">(</span>
            <span class="n">y_true</span><span class="o">=</span><span class="n">curr_scores</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">],</span>
            <span class="n">y_prob</span><span class="o">=</span><span class="n">curr_scores</span><span class="p">[</span><span class="s2">&quot;risk_score&quot;</span><span class="p">],</span>
            <span class="n">n_bins</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
            <span class="n">strategy</span><span class="o">=</span><span class="s2">&quot;quantile&quot;</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">prettify_model_name</span><span class="p">(</span><span class="n">curr_row</span><span class="p">[</span><span class="s2">&quot;base_name&quot;</span><span class="p">]),</span>
            <span class="n">linestyle</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;-.&quot;</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot;--&quot;</span><span class="p">][</span><span class="n">idx</span> <span class="o">%</span> <span class="mi">3</span><span class="p">],</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">ylabel</span> <span class="o">=</span> <span class="s2">&quot;Fraction of positives &quot;</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;$\left(\mathrm</span><span class="si">{P}</span><span class="s2">[Y=1]\right)$&quot;</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>

<span class="n">xlabel</span> <span class="o">=</span> <span class="s2">&quot;Mean predicted probability&quot;</span> <span class="c1"># + r&quot; $(\mathbb{E}[R])$&quot;</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Base models&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Instruction-tuned models&quot;</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>

<span class="c1"># Legent to the right of the right-most plot</span>
<span class="n">h</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
<span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Perf. calibrated&quot;</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">h</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">l</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>

<span class="n">save_fig</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;calibration-curves-base-and-instr.large-models.pdf&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Saved figure to &#39;../results/imgs/calibration-curves-base-and-instr.large-models.numeric-prompt.pdf&#39;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_paper-plots-and-tables_52_1.png" src="../_images/notebooks_paper-plots-and-tables_52_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.calibration</span><span class="w"> </span><span class="kn">import</span> <span class="n">CalibrationDisplay</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">prettify_model_name</span>

<span class="n">base_models_to_plot</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;base_name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span> <span class="k">if</span> <span class="s2">&quot;gemma&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>

<span class="n">base_models_to_plot</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;Meta-Llama-3-70B&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Mixtral-8x7B-v0.1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Mixtral-8x22B-v0.1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Yi-34B&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">instr_models_to_plot</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">df</span><span class="p">[</span>
        <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;base_name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">m</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">model_col</span><span class="p">]</span> <span class="o">!=</span> <span class="n">m</span><span class="p">)</span>
    <span class="p">][</span><span class="n">model_col</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">base_models_to_plot</span>
<span class="p">]</span>

<span class="c1"># Add GPT models if any</span>
<span class="n">instr_models_to_plot</span> <span class="o">+=</span> <span class="p">[</span><span class="n">m</span><span class="p">[</span><span class="n">model_col</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()</span> <span class="k">if</span> <span class="s2">&quot;gpt&quot;</span> <span class="ow">in</span> <span class="n">m</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mf">2.2</span><span class="p">),</span> <span class="n">gridspec_kw</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.15</span><span class="p">),</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Plot base models</span>
<span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">model_list</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="p">(</span><span class="n">base_models_to_plot</span><span class="p">,</span> <span class="n">instr_models_to_plot</span><span class="p">)):</span>

    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">model_list</span><span class="p">):</span>

        <span class="n">curr_row</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">model_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">m</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">curr_scores</span> <span class="o">=</span> <span class="n">scores_df_map</span><span class="p">[</span><span class="n">curr_row</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>

        <span class="n">disp</span> <span class="o">=</span> <span class="n">CalibrationDisplay</span><span class="o">.</span><span class="n">from_predictions</span><span class="p">(</span>
            <span class="n">y_true</span><span class="o">=</span><span class="n">curr_scores</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">],</span>
            <span class="n">y_prob</span><span class="o">=</span><span class="n">curr_scores</span><span class="p">[</span><span class="s2">&quot;risk_score&quot;</span><span class="p">],</span>
            <span class="n">n_bins</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
            <span class="n">strategy</span><span class="o">=</span><span class="s2">&quot;quantile&quot;</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">prettify_model_name</span><span class="p">(</span><span class="n">curr_row</span><span class="p">[</span><span class="s2">&quot;base_name&quot;</span><span class="p">]),</span>
            <span class="n">linestyle</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;-.&quot;</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot;--&quot;</span><span class="p">][</span><span class="n">idx</span> <span class="o">%</span> <span class="mi">3</span><span class="p">],</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
            <span class="n">ms</span><span class="o">=</span><span class="mf">3.5</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">ylabel</span> <span class="o">=</span> <span class="s2">&quot;Fraction of positives &quot;</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;$\left(\mathrm</span><span class="si">{P}</span><span class="s2">[Y=1]\right)$&quot;</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>
<span class="c1"># axes[1].set_ylabel(ylabel)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

<span class="c1"># xlabel = &quot;Mean predicted probability&quot; # + r&quot; $(\mathbb{E}[R])$&quot;</span>
<span class="n">xlabel</span> <span class="o">=</span> <span class="s2">&quot;Mean risk score&quot;</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Base models&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Instruction-tuned&quot;</span><span class="p">)</span>

<span class="c1"># Set prettier x ticks</span>
<span class="n">xticks</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">xticks_labels</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;0.0&quot;</span><span class="p">,</span> <span class="s2">&quot;0.25&quot;</span><span class="p">,</span> <span class="s2">&quot;0.5&quot;</span><span class="p">,</span> <span class="s2">&quot;0.75&quot;</span><span class="p">,</span> <span class="s2">&quot;1.0&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">xticks</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">xticks_labels</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">xticks</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">xticks_labels</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>

<span class="c1"># Legent to the right of the right-most plot</span>
<span class="k">if</span> <span class="n">NUMERIC_PROMPTING</span><span class="p">:</span>
    <span class="n">h</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
    <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Perf. calibrated&quot;</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">h</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">l</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>

<span class="c1"># Figure title</span>
<span class="k">if</span> <span class="n">NUMERIC_PROMPTING</span><span class="p">:</span>
    <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Numeric Prompting&quot;</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Multiple-choice Prompting&quot;</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.1</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>

<span class="n">save_fig</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;calibration-curves-base-and-instr.large-models.smaller.pdf&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Saved figure to &#39;../results/imgs/calibration-curves-base-and-instr.large-models.smaller.numeric-prompt.pdf&#39;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_paper-plots-and-tables_54_1.png" src="../_images/notebooks_paper-plots-and-tables_54_1.png" />
</div>
</div>
</section>
<section id="Calibration-per-sub-group">
<h2>Calibration per sub-group<a class="headerlink" href="#Calibration-per-sub-group" title="Link to this heading"></a></h2>
<p>Plot calibration curves per race sub-group, for each model pair.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="n">acs_dataset</span> <span class="o">=</span> <span class="n">ACSDataset</span><span class="o">.</span><span class="n">make_from_task</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">TASK</span><span class="p">,</span> <span class="n">cache_dir</span><span class="o">=</span><span class="n">DATA_DIR</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Loading ACS data...
CPU times: user 41.3 s, sys: 28.3 s, total: 1min 9s
Wall time: 1min 9s
</pre></div></div>
</div>
<p>Plot:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[35]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Omit small groups from the plots (results can be too noisy)</span>
<span class="n">OMIT_GROUPS_BELOW_PCT</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">N_BINS</span> <span class="o">=</span> <span class="mi">10</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[36]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sens_attr_col</span> <span class="o">=</span> <span class="s2">&quot;RAC1P&quot;</span>
<span class="n">sens_attr_map</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;White&quot;</span><span class="p">,</span>
    <span class="mi">2</span><span class="p">:</span> <span class="s2">&quot;Black&quot;</span><span class="p">,</span>
    <span class="mi">6</span><span class="p">:</span> <span class="s2">&quot;Asian&quot;</span><span class="p">,</span>
    <span class="c1"># 8: &quot;Other&quot;,   # some other race alone</span>
<span class="p">}</span>

<span class="n">name_to_sens_attr_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">val</span><span class="p">:</span> <span class="n">key</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">sens_attr_map</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

<span class="k">def</span><span class="w"> </span><span class="nf">plot_cali_curve</span><span class="p">(</span><span class="n">model_id</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plot sub-group calibration curves using sklearn&quot;&quot;&quot;</span>

    <span class="n">curr_row</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">model_id</span><span class="p">]</span>
    <span class="n">curr_scores_df</span> <span class="o">=</span> <span class="n">scores_df_map</span><span class="p">[</span><span class="n">curr_row</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>

    <span class="n">y_true</span> <span class="o">=</span> <span class="n">curr_scores_df</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">y_scores</span> <span class="o">=</span> <span class="n">curr_scores_df</span><span class="p">[</span><span class="s2">&quot;risk_score&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

    <span class="n">sens_attr</span> <span class="o">=</span> <span class="n">acs_dataset</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">curr_scores_df</span><span class="o">.</span><span class="n">index</span><span class="p">][</span><span class="n">sens_attr_col</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">group_val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">sens_attr</span><span class="p">)):</span>
        <span class="n">group_filter</span> <span class="o">=</span> <span class="n">sens_attr</span> <span class="o">==</span> <span class="n">group_val</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">group_filter</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">group_filter</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="n">OMIT_GROUPS_BELOW_PCT</span><span class="p">:</span>
            <span class="c1"># print(f&quot;Skipping group={group_val}&quot;)</span>
            <span class="k">continue</span>

        <span class="n">disp</span> <span class="o">=</span> <span class="n">CalibrationDisplay</span><span class="o">.</span><span class="n">from_predictions</span><span class="p">(</span>
            <span class="n">y_true</span><span class="o">=</span><span class="n">y_true</span><span class="p">[</span><span class="n">group_filter</span><span class="p">],</span>
            <span class="n">y_prob</span><span class="o">=</span><span class="n">y_scores</span><span class="p">[</span><span class="n">group_filter</span><span class="p">],</span>
            <span class="n">n_bins</span><span class="o">=</span><span class="n">N_BINS</span><span class="p">,</span>
            <span class="c1"># strategy=&quot;uniform&quot;,</span>
            <span class="n">strategy</span><span class="o">=</span><span class="s2">&quot;quantile&quot;</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">sens_attr_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">group_val</span><span class="p">,</span> <span class="n">group_val</span><span class="p">)),</span>
            <span class="n">linestyle</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;-.&quot;</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot;--&quot;</span><span class="p">][</span><span class="n">idx</span> <span class="o">%</span> <span class="mi">3</span><span class="p">],</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># Set other plot settings</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">curr_row</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">disp</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[37]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">folktexts.evaluation</span><span class="w"> </span><span class="kn">import</span> <span class="n">bootstrap_estimate</span>

<span class="k">def</span><span class="w"> </span><span class="nf">plot_cali_curve_ci</span><span class="p">(</span><span class="n">model_id</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">ci</span><span class="o">=</span><span class="mi">95</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plot sub-group calibration curves with bootstrap confidence intervals&quot;&quot;&quot;</span>

    <span class="n">curr_row</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">model_id</span><span class="p">]</span>
    <span class="n">curr_scores_df</span> <span class="o">=</span> <span class="n">scores_df_map</span><span class="p">[</span><span class="n">curr_row</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>

    <span class="n">y_true</span> <span class="o">=</span> <span class="n">curr_scores_df</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">y_scores</span> <span class="o">=</span> <span class="n">curr_scores_df</span><span class="p">[</span><span class="s2">&quot;risk_score&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

    <span class="n">sens_attr</span> <span class="o">=</span> <span class="n">acs_dataset</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">curr_scores_df</span><span class="o">.</span><span class="n">index</span><span class="p">][</span><span class="n">sens_attr_col</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

    <span class="c1"># Compute bins</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y_scores</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">curr_row</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
        <span class="k">return</span>

    <span class="n">y_scores_binned</span><span class="p">,</span> <span class="n">bin_edges</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">y_scores</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="n">N_BINS</span><span class="p">,</span> <span class="n">retbins</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">duplicates</span><span class="o">=</span><span class="s2">&quot;drop&quot;</span><span class="p">)</span>
    <span class="n">bin_names</span> <span class="o">=</span> <span class="n">y_scores_binned</span><span class="o">.</span><span class="n">categories</span>   <span class="c1"># Name used for each bin: &quot;(bin_low_range, bin_high_range)&quot;</span>

    <span class="c1"># To hold plot render artifacts</span>
    <span class="n">plot_artifacts</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">group_val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">sens_attr</span><span class="p">)):</span>
        <span class="n">group_filter</span> <span class="o">=</span> <span class="n">sens_attr</span> <span class="o">==</span> <span class="n">group_val</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">group_filter</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">group_filter</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="n">OMIT_GROUPS_BELOW_PCT</span>
            <span class="ow">or</span> <span class="n">group_val</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sens_attr_map</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="p">):</span>
            <span class="c1"># print(f&quot;Skipping group={group_val}&quot;)</span>
            <span class="k">continue</span>

        <span class="n">group_labels</span> <span class="o">=</span> <span class="n">y_true</span><span class="p">[</span><span class="n">group_filter</span><span class="p">]</span>
        <span class="n">group_scores</span> <span class="o">=</span> <span class="n">y_scores</span><span class="p">[</span><span class="n">group_filter</span><span class="p">]</span>

        <span class="n">group_cali_points</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bin_names</span><span class="p">:</span>
            <span class="n">bin_filter</span> <span class="o">=</span> <span class="n">y_scores_binned</span> <span class="o">==</span> <span class="n">b</span>

            <span class="n">group_labels_current_bin</span> <span class="o">=</span> <span class="n">y_true</span><span class="p">[</span><span class="n">group_filter</span> <span class="o">&amp;</span> <span class="n">bin_filter</span><span class="p">]</span>
            <span class="n">group_scores_current_bin</span> <span class="o">=</span> <span class="n">y_scores</span><span class="p">[</span><span class="n">group_filter</span> <span class="o">&amp;</span> <span class="n">bin_filter</span><span class="p">]</span>

            <span class="n">results</span> <span class="o">=</span> <span class="n">bootstrap_estimate</span><span class="p">(</span>
                <span class="n">eval_func</span><span class="o">=</span><span class="k">lambda</span> <span class="n">labels</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">sensattr</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;mean_score&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">scores</span><span class="p">),</span>
                    <span class="s2">&quot;mean_label&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">labels</span><span class="p">),</span>
                <span class="p">},</span>
                <span class="n">y_true</span><span class="o">=</span><span class="n">group_labels_current_bin</span><span class="p">,</span>
                <span class="n">y_pred_scores</span><span class="o">=</span><span class="n">group_scores_current_bin</span><span class="p">,</span>
                <span class="n">sensitive_attribute</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Store plot point for this bin</span>
            <span class="n">group_cali_points</span><span class="o">.</span><span class="n">append</span><span class="p">((</span>
                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;mean_score_mean&quot;</span><span class="p">],</span>    <span class="c1"># x coordinate</span>
                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;mean_label_mean&quot;</span><span class="p">],</span>    <span class="c1"># y coordinate</span>
                <span class="p">(</span>                              <span class="c1"># y coordinate c.i. range</span>
                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;mean_label_low-percentile&quot;</span><span class="p">],</span>
                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;mean_label_high-percentile&quot;</span><span class="p">],</span>
                <span class="p">),</span>
            <span class="p">))</span>

        <span class="c1"># Get group label from sensitive attribute map</span>
        <span class="n">group_label</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">sens_attr_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">group_val</span><span class="p">,</span> <span class="n">group_val</span><span class="p">))</span>

        <span class="c1"># Plot this group&#39;s calibration curve w/ conf. intervals!</span>
        <span class="n">line</span><span class="p">,</span> <span class="n">caps</span><span class="p">,</span> <span class="n">bars</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span>
            <span class="c1"># x=[mean_score for mean_score, *_ in group_cali_points],</span>
            <span class="n">x</span><span class="o">=</span><span class="p">[(</span><span class="n">bin_edges</span><span class="p">[</span><span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">bin_edges</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">bin_edges</span><span class="p">))],</span>
            <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="n">mean_label</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">mean_label</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">group_cali_points</span><span class="p">],</span>
            <span class="n">yerr</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">yerr_range</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">_x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">yerr_range</span> <span class="ow">in</span> <span class="n">group_cali_points</span><span class="p">]</span>
            <span class="p">),</span>
            <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">linestyle</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;-.&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;--&quot;</span><span class="p">][</span><span class="n">idx</span> <span class="o">%</span> <span class="mi">3</span><span class="p">],</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="n">group_label</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">plot_artifacts</span><span class="p">[</span><span class="n">group_label</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">caps</span><span class="p">,</span> <span class="n">bars</span><span class="p">)</span>

    <span class="c1"># Global plot settings</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;dotted&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Draw custom legend</span>
    <span class="n">handles</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">group</span><span class="p">,</span> <span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="ow">in</span> <span class="n">plot_artifacts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">l</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
        <span class="n">l</span><span class="o">.</span><span class="n">set_markersize</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">handles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>

    <span class="c1"># Perfectly calibrated line</span>
    <span class="n">perf_cal_line</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Line2D</span><span class="p">([],</span> <span class="p">[],</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Perf. calibrated&quot;</span><span class="p">)</span>

    <span class="c1"># Confidence interv. marker line</span>
    <span class="n">conf_int_line</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Line2D</span><span class="p">([],</span> <span class="p">[],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;|&quot;</span><span class="p">,</span> <span class="n">markeredgewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$95\%$ conf. int.&quot;</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">handles</span> <span class="o">+</span> <span class="p">[</span><span class="n">conf_int_line</span><span class="p">,</span> <span class="n">perf_cal_line</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">curr_row</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">disp</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[38]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.calibration</span><span class="w"> </span><span class="kn">import</span> <span class="n">CalibrationDisplay</span>

<span class="c1"># Get results for the current task</span>
<span class="n">task_df</span> <span class="o">=</span> <span class="n">all_results_df</span><span class="p">[</span><span class="n">all_results_df</span><span class="p">[</span><span class="n">task_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">TASK</span><span class="p">]</span>

<span class="c1"># Get all base/instruct model pairs</span>
<span class="n">base_models_to_plot</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;Meta-Llama-3-8B&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Meta-Llama-3-70B&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Mistral-7B-v0.1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Mixtral-8x7B-v0.1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Mixtral-8x22B-v0.1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Yi-34B&quot;</span><span class="p">,</span>
<span class="p">]</span>
<span class="c1"># NOTE: Gemma models have degenerate distributions that always predict the same score, can&#39;t plot calibration properly...</span>

<span class="n">instr_models_to_plot</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">df</span><span class="p">[</span>
        <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;base_name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">m</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">model_col</span><span class="p">]</span> <span class="o">!=</span> <span class="n">m</span><span class="p">)</span>
    <span class="p">][</span><span class="n">model_col</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">base_models_to_plot</span>
<span class="p">]</span>

<span class="c1"># Add GPT models if any</span>
<span class="n">instr_models_to_plot</span> <span class="o">+=</span> <span class="p">[</span><span class="n">m</span><span class="p">[</span><span class="n">model_col</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()</span> <span class="k">if</span> <span class="s2">&quot;gpt&quot;</span> <span class="ow">in</span> <span class="n">m</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
<span class="n">base_models_to_plot</span> <span class="o">+=</span> <span class="p">[</span><span class="kc">None</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">instr_models_to_plot</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">base_models_to_plot</span><span class="p">))]</span>

<span class="n">base_it_pairs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">base_models_to_plot</span><span class="p">,</span> <span class="n">instr_models_to_plot</span><span class="p">))</span>

<span class="k">for</span> <span class="n">base_model</span><span class="p">,</span> <span class="n">it_model</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">base_it_pairs</span><span class="p">):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mf">2.8</span><span class="p">),</span> <span class="n">gridspec_kw</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.35</span><span class="p">),</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">)),</span> <span class="n">axes</span><span class="p">,</span> <span class="p">(</span><span class="n">base_model</span><span class="p">,</span> <span class="n">it_model</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
            <span class="k">continue</span>

        <span class="n">curr_row</span> <span class="o">=</span> <span class="n">task_df</span><span class="p">[(</span><span class="n">task_df</span><span class="p">[</span><span class="n">model_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">m</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">task_df</span><span class="p">[</span><span class="s2">&quot;uses_all_features&quot;</span><span class="p">])]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">curr_id</span> <span class="o">=</span> <span class="n">curr_row</span><span class="o">.</span><span class="n">name</span>

        <span class="c1"># # Original sklearn calibration plot:</span>
        <span class="c1"># plot_cali_curve(curr_id, ax=ax, df=task_df)</span>

        <span class="c1"># # Plot with confidence intervals:</span>
        <span class="n">plot_cali_curve_ci</span><span class="p">(</span><span class="n">curr_id</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">task_df</span><span class="p">)</span>

        <span class="c1"># Remove left plot legend</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">get_legend</span><span class="p">()</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">get_legend</span><span class="p">()</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Mean risk score&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Fraction of positives&quot;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
    <span class="n">save_fig</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;calibration-curves-per-subgroup.</span><span class="si">{</span><span class="n">base_model</span><span class="si">}</span><span class="s2">.pdf&quot;</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "818d39dfd7f14966b96c35233df9c3a9", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Saved figure to &#39;../results/imgs/calibration-curves-per-subgroup.Meta-Llama-3-8B.numeric-prompt.pdf&#39;
Saved figure to &#39;../results/imgs/calibration-curves-per-subgroup.Meta-Llama-3-70B.numeric-prompt.pdf&#39;
Saved figure to &#39;../results/imgs/calibration-curves-per-subgroup.Mistral-7B-v0.1.numeric-prompt.pdf&#39;
Saved figure to &#39;../results/imgs/calibration-curves-per-subgroup.Mixtral-8x7B-v0.1.numeric-prompt.pdf&#39;
Saved figure to &#39;../results/imgs/calibration-curves-per-subgroup.Mixtral-8x22B-v0.1.numeric-prompt.pdf&#39;
Saved figure to &#39;../results/imgs/calibration-curves-per-subgroup.Yi-34B.numeric-prompt.pdf&#39;
Saved figure to &#39;../results/imgs/calibration-curves-per-subgroup.None.numeric-prompt.pdf&#39;
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_paper-plots-and-tables_62_2.png" src="../_images/notebooks_paper-plots-and-tables_62_2.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_paper-plots-and-tables_62_3.png" src="../_images/notebooks_paper-plots-and-tables_62_3.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_paper-plots-and-tables_62_4.png" src="../_images/notebooks_paper-plots-and-tables_62_4.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_paper-plots-and-tables_62_5.png" src="../_images/notebooks_paper-plots-and-tables_62_5.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_paper-plots-and-tables_62_6.png" src="../_images/notebooks_paper-plots-and-tables_62_6.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_paper-plots-and-tables_62_7.png" src="../_images/notebooks_paper-plots-and-tables_62_7.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_paper-plots-and-tables_62_8.png" src="../_images/notebooks_paper-plots-and-tables_62_8.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[39]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.calibration</span><span class="w"> </span><span class="kn">import</span> <span class="n">CalibrationDisplay</span>

<span class="c1"># Get results for the current task</span>
<span class="n">task_df</span> <span class="o">=</span> <span class="n">all_results_df</span><span class="p">[</span><span class="n">all_results_df</span><span class="p">[</span><span class="n">task_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">TASK</span><span class="p">]</span>

<span class="c1"># Get all base/instruct model pairs</span>
<span class="n">base_models_to_plot</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;Meta-Llama-3-8B&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Meta-Llama-3-70B&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Mistral-7B-v0.1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Mixtral-8x7B-v0.1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Mixtral-8x22B-v0.1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Yi-34B&quot;</span><span class="p">,</span>
<span class="p">]</span>
<span class="c1"># NOTE: Gemma models have degenerate distributions that always predict the same score, can&#39;t plot calibration properly...</span>

<span class="n">instr_models_to_plot</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">df</span><span class="p">[</span>
        <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;base_name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">m</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">model_col</span><span class="p">]</span> <span class="o">!=</span> <span class="n">m</span><span class="p">)</span>
    <span class="p">][</span><span class="n">model_col</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">base_models_to_plot</span>
<span class="p">]</span>

<span class="c1"># Add GPT models if any</span>
<span class="n">instr_models_to_plot</span> <span class="o">+=</span> <span class="p">[</span><span class="n">m</span><span class="p">[</span><span class="n">model_col</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()</span> <span class="k">if</span> <span class="s2">&quot;gpt&quot;</span> <span class="ow">in</span> <span class="n">m</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
<span class="n">base_models_to_plot</span> <span class="o">+=</span> <span class="p">[</span><span class="kc">None</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">instr_models_to_plot</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">base_models_to_plot</span><span class="p">))]</span>

<span class="n">base_it_pairs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">base_models_to_plot</span><span class="p">,</span> <span class="n">instr_models_to_plot</span><span class="p">))</span>

<span class="k">for</span> <span class="n">base_model</span><span class="p">,</span> <span class="n">it_model</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">base_it_pairs</span><span class="p">):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">4.8</span><span class="p">,</span> <span class="mf">2.2</span><span class="p">),</span> <span class="n">gridspec_kw</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.15</span><span class="p">),</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">)),</span> <span class="n">axes</span><span class="p">,</span> <span class="p">(</span><span class="n">base_model</span><span class="p">,</span> <span class="n">it_model</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
            <span class="k">continue</span>

        <span class="n">curr_row</span> <span class="o">=</span> <span class="n">task_df</span><span class="p">[(</span><span class="n">task_df</span><span class="p">[</span><span class="n">model_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">m</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">task_df</span><span class="p">[</span><span class="s2">&quot;uses_all_features&quot;</span><span class="p">])]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">curr_id</span> <span class="o">=</span> <span class="n">curr_row</span><span class="o">.</span><span class="n">name</span>

        <span class="c1"># # Original sklearn calibration plot:</span>
        <span class="c1"># plot_cali_curve(curr_id, ax=ax, df=task_df)</span>

        <span class="c1"># # Plot with confidence intervals:</span>
        <span class="n">plot_cali_curve_ci</span><span class="p">(</span><span class="n">curr_id</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">task_df</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Mean risk score&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Fraction of positives&quot;</span><span class="p">)</span>

        <span class="c1"># Set prettier x-ticks</span>
        <span class="n">xticks</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">xticks_labels</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;0.0&quot;</span><span class="p">,</span> <span class="s2">&quot;0.25&quot;</span><span class="p">,</span> <span class="s2">&quot;0.5&quot;</span><span class="p">,</span> <span class="s2">&quot;0.75&quot;</span><span class="p">,</span> <span class="s2">&quot;1.0&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">xticks</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">xticks_labels</span><span class="p">)</span>

    <span class="c1"># Prepare legend</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">NUMERIC_PROMPTING</span><span class="p">:</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_legend</span><span class="p">()</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.03</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>

    <span class="c1"># Figure title</span>
    <span class="k">if</span> <span class="n">NUMERIC_PROMPTING</span><span class="p">:</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Numeric Prompting&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Multiple-choice Prompting&quot;</span>

    <span class="c1"># Don&#39;t use suptitle for GPT4 (no base model)</span>
    <span class="k">if</span> <span class="n">base_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.1</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">model_title</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_title</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">model_title</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
    <span class="n">save_fig</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;calibration-curves-per-subgroup.</span><span class="si">{</span><span class="n">base_model</span><span class="si">}</span><span class="s2">.smaller.pdf&quot;</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "cd4b354cb3c140238849fe9f583968d2", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Saved figure to &#39;../results/imgs/calibration-curves-per-subgroup.Meta-Llama-3-8B.smaller.numeric-prompt.pdf&#39;
Saved figure to &#39;../results/imgs/calibration-curves-per-subgroup.Meta-Llama-3-70B.smaller.numeric-prompt.pdf&#39;
Saved figure to &#39;../results/imgs/calibration-curves-per-subgroup.Mistral-7B-v0.1.smaller.numeric-prompt.pdf&#39;
Saved figure to &#39;../results/imgs/calibration-curves-per-subgroup.Mixtral-8x7B-v0.1.smaller.numeric-prompt.pdf&#39;
Saved figure to &#39;../results/imgs/calibration-curves-per-subgroup.Mixtral-8x22B-v0.1.smaller.numeric-prompt.pdf&#39;
Saved figure to &#39;../results/imgs/calibration-curves-per-subgroup.Yi-34B.smaller.numeric-prompt.pdf&#39;
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING:matplotlib.legend:No artists with labels found to put in legend.  Note that artists whose label start with an underscore are ignored when legend() is called with no argument.
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Saved figure to &#39;../results/imgs/calibration-curves-per-subgroup.None.smaller.numeric-prompt.pdf&#39;
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_paper-plots-and-tables_64_4.png" src="../_images/notebooks_paper-plots-and-tables_64_4.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_paper-plots-and-tables_64_5.png" src="../_images/notebooks_paper-plots-and-tables_64_5.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_paper-plots-and-tables_64_6.png" src="../_images/notebooks_paper-plots-and-tables_64_6.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_paper-plots-and-tables_64_7.png" src="../_images/notebooks_paper-plots-and-tables_64_7.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_paper-plots-and-tables_64_8.png" src="../_images/notebooks_paper-plots-and-tables_64_8.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_paper-plots-and-tables_64_9.png" src="../_images/notebooks_paper-plots-and-tables_64_9.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_paper-plots-and-tables_64_10.png" src="../_images/notebooks_paper-plots-and-tables_64_10.png" />
</div>
</div>
</section>
<section id="Score-distribution-per-sub-group">
<h2>Score distribution per sub-group<a class="headerlink" href="#Score-distribution-per-sub-group" title="Link to this heading"></a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[40]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sens_attr_data</span> <span class="o">=</span> <span class="n">acs_dataset</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">sens_attr_col</span><span class="p">]</span>
<span class="n">sens_attr_data</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[40]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
1    2
2    1
8    1
Name: RAC1P, dtype: int64
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[41]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot settings</span>
<span class="n">plot_config</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="n">binrange</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="n">stat</span><span class="o">=</span><span class="s2">&quot;percent&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="k">for</span> <span class="n">base_model</span><span class="p">,</span> <span class="n">it_model</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">base_it_pairs</span><span class="p">):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">gridspec_kw</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.33</span><span class="p">),</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">)),</span> <span class="n">axes</span><span class="p">,</span> <span class="p">(</span><span class="n">base_model</span><span class="p">,</span> <span class="n">it_model</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
            <span class="k">continue</span>

        <span class="n">model_row</span> <span class="o">=</span> <span class="n">task_df</span><span class="p">[(</span><span class="n">task_df</span><span class="p">[</span><span class="n">model_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">m</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">task_df</span><span class="p">[</span><span class="s2">&quot;uses_all_features&quot;</span><span class="p">])]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">model_id</span> <span class="o">=</span> <span class="n">model_row</span><span class="o">.</span><span class="n">name</span>

        <span class="n">scores_df</span> <span class="o">=</span> <span class="n">scores_df_map</span><span class="p">[</span><span class="n">model_id</span><span class="p">]</span>
        <span class="n">scores_df</span><span class="p">[</span><span class="s2">&quot;group&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sens_attr_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">scores_df</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>

        <span class="c1"># sns.histplot(</span>
        <span class="c1">#     data=scores_df,</span>
        <span class="c1">#     x=&quot;risk_score&quot;,</span>
        <span class="c1">#     hue=&quot;group&quot;,</span>
        <span class="c1">#     ax=ax,</span>
        <span class="c1">#     **plot_config,</span>
        <span class="c1"># )</span>

        <span class="k">for</span> <span class="n">group_val</span><span class="p">,</span> <span class="n">group_name</span> <span class="ow">in</span> <span class="n">sens_attr_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">group_scores_df</span> <span class="o">=</span> <span class="n">scores_df</span><span class="p">[</span><span class="n">sens_attr_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">scores_df</span><span class="o">.</span><span class="n">index</span><span class="p">]</span> <span class="o">==</span> <span class="n">group_val</span><span class="p">]</span>
            <span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span>
                <span class="n">group_scores_df</span><span class="p">[</span><span class="s2">&quot;risk_score&quot;</span><span class="p">],</span>
                <span class="n">label</span><span class="o">=</span><span class="n">group_name</span><span class="p">,</span>
                <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                <span class="o">**</span><span class="n">plot_config</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Remove left plot legend</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># ax.set_ylim(0, 1)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">model_row</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
    <span class="n">save_fig</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;score-per-subgroup.</span><span class="si">{</span><span class="n">base_model</span><span class="si">}</span><span class="s2">.pdf&quot;</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "ad627657fb0044bb9f3620c89dc7d648", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Saved figure to &#39;../results/imgs/score-per-subgroup.Meta-Llama-3-8B.numeric-prompt.pdf&#39;
Saved figure to &#39;../results/imgs/score-per-subgroup.Meta-Llama-3-70B.numeric-prompt.pdf&#39;
Saved figure to &#39;../results/imgs/score-per-subgroup.Mistral-7B-v0.1.numeric-prompt.pdf&#39;
Saved figure to &#39;../results/imgs/score-per-subgroup.Mixtral-8x7B-v0.1.numeric-prompt.pdf&#39;
Saved figure to &#39;../results/imgs/score-per-subgroup.Mixtral-8x22B-v0.1.numeric-prompt.pdf&#39;
Saved figure to &#39;../results/imgs/score-per-subgroup.Yi-34B.numeric-prompt.pdf&#39;
Saved figure to &#39;../results/imgs/score-per-subgroup.None.numeric-prompt.pdf&#39;
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_paper-plots-and-tables_67_2.png" src="../_images/notebooks_paper-plots-and-tables_67_2.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_paper-plots-and-tables_67_3.png" src="../_images/notebooks_paper-plots-and-tables_67_3.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_paper-plots-and-tables_67_4.png" src="../_images/notebooks_paper-plots-and-tables_67_4.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_paper-plots-and-tables_67_5.png" src="../_images/notebooks_paper-plots-and-tables_67_5.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_paper-plots-and-tables_67_6.png" src="../_images/notebooks_paper-plots-and-tables_67_6.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_paper-plots-and-tables_67_7.png" src="../_images/notebooks_paper-plots-and-tables_67_7.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_paper-plots-and-tables_67_8.png" src="../_images/notebooks_paper-plots-and-tables_67_8.png" />
</div>
</div>
</section>
<section id="Compute-mean-under-/over-estimation-of-risk-score">
<h2>Compute mean under-/over-estimation of risk score<a class="headerlink" href="#Compute-mean-under-/over-estimation-of-risk-score" title="Link to this heading"></a></h2>
<p>It’s basocally akin to computing ECE without the absolute…</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[42]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">compute_confidence_bias_metric_helper</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Helper to compute the under- / over-confidence metric.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mean_label</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">mean_score</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;risk_score&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">mean_score</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">mean_score</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">mean_label</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">mean_score</span> <span class="o">-</span> <span class="n">mean_label</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">compute_confidence_bias_metric</span><span class="p">(</span><span class="n">model_id</span><span class="p">,</span> <span class="n">quantiled_bins</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">scores_df</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">scores_df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">scores_df</span> <span class="o">=</span> <span class="n">scores_df_map</span><span class="p">[</span><span class="n">model_id</span><span class="p">]</span>

    <span class="n">discretization_func</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">qcut</span> <span class="k">if</span> <span class="n">quantiled_bins</span> <span class="k">else</span> <span class="n">pd</span><span class="o">.</span><span class="n">cut</span>
    <span class="n">scores_df</span><span class="p">[</span><span class="s2">&quot;score_bin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">discretization_func</span><span class="p">(</span><span class="n">scores_df</span><span class="p">[</span><span class="s2">&quot;risk_score&quot;</span><span class="p">],</span> <span class="mi">10</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>

    <span class="n">bias_metric_val</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">scores_df</span><span class="p">))</span> <span class="o">*</span> <span class="nb">sum</span><span class="p">(</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">bin_data</span><span class="p">)</span> <span class="o">*</span> <span class="n">compute_confidence_bias_metric_helper</span><span class="p">(</span><span class="n">bin_data</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">bin_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bin_data</span> <span class="o">:=</span> <span class="n">scores_df</span><span class="p">[</span><span class="n">scores_df</span><span class="p">[</span><span class="s2">&quot;score_bin&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">bin_</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">bias_metric_val</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[43]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">confidence_scores</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">m</span><span class="p">:</span> <span class="n">compute_confidence_bias_metric</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">scores_df_map</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "81416b6ae6a041bdacc00c142bcdb7b9", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[44]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">all_results_df</span><span class="p">[</span><span class="s2">&quot;under_over_score&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_results_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">confidence_scores</span><span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">all_results_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;under_over_score&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="s2">&quot;under_over_score&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[44]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Meta-Llama-3-8B-Instruct__ACSPublicCoverage__-1__Num     -0.161384
Mixtral-8x7B-Instruct-v0.1__ACSPublicCoverage__-1__Num   -0.061690
Mixtral-8x7B-Instruct-v0.1__ACSEmployment__-1__Num       -0.056597
Meta-Llama-3-70B-Instruct__ACSPublicCoverage__-1__Num    -0.052221
gemma-7b__ACSIncome__-1__Num                             -0.033482
                                                            ...
gemma-7b__ACSEmployment__-1__Num                          0.341868
Mistral-7B-v0.1__ACSIncome__-1__Num                       0.355603
gemma-2b__ACSIncome__-1__Num                              0.367876
Mistral-7B-v0.1__ACSTravelTime__-1__Num                   0.438141
gemma-2b__ACSTravelTime__-1__Num                          0.438312
Name: under_over_score, Length: 100, dtype: float64
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[45]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">TASK</span> <span class="o">=</span> <span class="s2">&quot;ACSIncome&quot;</span>
<span class="c1"># TASK = &quot;ACSTravelTime&quot;</span>
<span class="c1"># TASK = &quot;ACSMobility&quot;</span>
<span class="c1"># TASK = &quot;ACSEmployment&quot;</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[46]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_df</span> <span class="o">=</span> <span class="n">all_results_df</span><span class="p">[</span>
    <span class="p">(</span><span class="n">all_results_df</span><span class="p">[</span><span class="n">task_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">TASK</span><span class="p">)</span>
    <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">all_results_df</span><span class="p">[</span><span class="n">numeric_prompt_col</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">())</span>
<span class="p">]</span>

<span class="c1"># Omit Gemma models bc they&#39;re garbage :)</span>
<span class="n">plot_df</span> <span class="o">=</span> <span class="n">plot_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="n">id_</span> <span class="k">for</span> <span class="n">id_</span> <span class="ow">in</span> <span class="n">plot_df</span><span class="o">.</span><span class="n">index</span> <span class="k">if</span> <span class="s2">&quot;gemma&quot;</span> <span class="ow">in</span> <span class="n">id_</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="s2">&quot;yi&quot;</span> <span class="ow">in</span> <span class="n">id_</span><span class="o">.</span><span class="n">lower</span><span class="p">()])</span>


<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span>
    <span class="n">data</span><span class="o">=</span><span class="n">plot_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;under_over_score&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">x</span><span class="o">=</span><span class="s2">&quot;under_over_score&quot;</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">,</span>
    <span class="c1"># y=task_col,</span>
    <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;is_inst&quot;</span><span class="p">,</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">handles</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">handles</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Base&quot;</span><span class="p">,</span> <span class="s2">&quot;Instruct&quot;</span><span class="p">])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\mathrm</span><span class="si">{R}</span><span class="s2">_\mathrm</span><span class="si">{bias}</span><span class="s2">$&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Risk score confidence bias&quot;</span><span class="p">)</span>

<span class="n">save_fig</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;under_over_score.</span><span class="si">{</span><span class="n">TASK</span><span class="si">}</span><span class="s2">.pdf&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Saved figure to &#39;../results/imgs/under_over_score.ACSIncome.numeric-prompt.pdf&#39;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_paper-plots-and-tables_73_1.png" src="../_images/notebooks_paper-plots-and-tables_73_1.png" />
</div>
</div>
</section>
<section id="Compute-risk-score-fairness-per-sub-group">
<h2>Compute risk score fairness per sub-group<a class="headerlink" href="#Compute-risk-score-fairness-per-sub-group" title="Link to this heading"></a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[47]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sens_attr_data</span> <span class="o">=</span> <span class="n">acs_dataset</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">sens_attr_col</span><span class="p">]</span>
<span class="n">sens_attr_data</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[47]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
1    2
2    1
8    1
Name: RAC1P, dtype: int64
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[48]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">compute_signed_score_bias</span><span class="p">(</span><span class="n">scores_df</span><span class="p">,</span> <span class="n">quantiled_bins</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">n_bins</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">discretization_func</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">qcut</span> <span class="k">if</span> <span class="n">quantiled_bins</span> <span class="k">else</span> <span class="n">pd</span><span class="o">.</span><span class="n">cut</span>
    <span class="n">scores_df</span><span class="p">[</span><span class="s2">&quot;score_bin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">discretization_func</span><span class="p">(</span><span class="n">scores_df</span><span class="p">[</span><span class="s2">&quot;risk_score&quot;</span><span class="p">],</span> <span class="n">n_bins</span><span class="p">,</span> <span class="n">duplicates</span><span class="o">=</span><span class="s2">&quot;drop&quot;</span><span class="p">,</span> <span class="n">retbins</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">bin_categories</span> <span class="o">=</span> <span class="n">scores_df</span><span class="p">[</span><span class="s2">&quot;score_bin&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">categories</span>

    <span class="k">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">scores_df</span><span class="p">))</span> <span class="o">*</span> <span class="nb">sum</span><span class="p">(</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">bin_data</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">bin_data</span><span class="p">[</span><span class="s2">&quot;risk_score&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">-</span> <span class="n">bin_data</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">bin_</span> <span class="ow">in</span> <span class="n">bin_categories</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bin_data</span> <span class="o">:=</span> <span class="n">scores_df</span><span class="p">[</span><span class="n">scores_df</span><span class="p">[</span><span class="s2">&quot;score_bin&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">bin_</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[49]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">compute_signed_subgroup_score_bias</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">group</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="n">scores_df</span> <span class="o">=</span> <span class="n">scores_df_map</span><span class="p">[</span><span class="n">model</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">group</span> <span class="o">=</span> <span class="n">name_to_sens_attr_map</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>

    <span class="n">scores_df</span> <span class="o">=</span> <span class="n">scores_df</span><span class="p">[</span><span class="n">sens_attr_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">scores_df</span><span class="o">.</span><span class="n">index</span><span class="p">]</span> <span class="o">==</span> <span class="n">group</span><span class="p">]</span>
    <span class="c1"># return compute_confidence_metric(model, scores_df=scores_df)</span>
    <span class="k">return</span> <span class="n">compute_signed_score_bias</span><span class="p">(</span><span class="n">scores_df</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">compute_calibration_fairness</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">priv_group</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span> <span class="n">unpriv_group</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">compute_signed_subgroup_score_bias</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">priv_group</span><span class="p">)</span>
        <span class="o">-</span> <span class="n">compute_signed_subgroup_score_bias</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">unpriv_group</span><span class="p">)</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[50]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">calibration_per_subgroup_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">_score_bias&quot;</span><span class="p">:</span> <span class="n">compute_signed_subgroup_score_bias</span><span class="p">(</span><span class="n">model_id</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">sens_attr_map</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="p">},</span>
        <span class="n">name</span><span class="o">=</span><span class="n">model_id</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">model_id</span> <span class="ow">in</span> <span class="n">task_df</span><span class="o">.</span><span class="n">index</span>
<span class="p">])</span>

<span class="n">calibration_per_subgroup_df</span><span class="p">[</span><span class="s2">&quot;White_v_Black_score_bias&quot;</span><span class="p">]</span> <span class="o">=</span> \
    <span class="n">calibration_per_subgroup_df</span><span class="p">[</span><span class="s2">&quot;White_score_bias&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">calibration_per_subgroup_df</span><span class="p">[</span><span class="s2">&quot;Black_score_bias&quot;</span><span class="p">]</span>

<span class="n">calibration_per_subgroup_df</span><span class="p">[</span><span class="s2">&quot;White_v_Asian_score_bias&quot;</span><span class="p">]</span> <span class="o">=</span> \
    <span class="n">calibration_per_subgroup_df</span><span class="p">[</span><span class="s2">&quot;White_score_bias&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">calibration_per_subgroup_df</span><span class="p">[</span><span class="s2">&quot;Asian_score_bias&quot;</span><span class="p">]</span>

<span class="n">calibration_per_subgroup_df</span><span class="p">[</span><span class="s2">&quot;Asian_v_Black_score_bias&quot;</span><span class="p">]</span> <span class="o">=</span> \
    <span class="n">calibration_per_subgroup_df</span><span class="p">[</span><span class="s2">&quot;Asian_score_bias&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">calibration_per_subgroup_df</span><span class="p">[</span><span class="s2">&quot;Black_score_bias&quot;</span><span class="p">]</span>

<span class="n">calibration_per_subgroup_df</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/tmp/ipykernel_3388197/3464681156.py:3: SettingWithCopyWarning:
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  scores_df[&#34;score_bin&#34;] = discretization_func(scores_df[&#34;risk_score&#34;], n_bins, duplicates=&#34;drop&#34;, retbins=False)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[50]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>White_score_bias</th>
      <th>Black_score_bias</th>
      <th>Asian_score_bias</th>
      <th>White_v_Black_score_bias</th>
      <th>White_v_Asian_score_bias</th>
      <th>Asian_v_Black_score_bias</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Mistral-7B-v0.1__ACSIncome__-1__Num</th>
      <td>0.353045</td>
      <td>0.329428</td>
      <td>0.319214</td>
      <td>0.023617</td>
      <td>0.033831</td>
      <td>-0.010215</td>
    </tr>
    <tr>
      <th>gemma-1.1-2b-it__ACSIncome__-1__Num</th>
      <td>0.260100</td>
      <td>0.403764</td>
      <td>0.202488</td>
      <td>-0.143664</td>
      <td>0.057612</td>
      <td>-0.201276</td>
    </tr>
    <tr>
      <th>Yi-34B-Chat__ACSIncome__-1__Num</th>
      <td>0.210531</td>
      <td>0.229600</td>
      <td>0.212839</td>
      <td>-0.019069</td>
      <td>-0.002308</td>
      <td>-0.016761</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p><strong>Note:</strong> This is an example of comparing risk score bias between different sub-groups. A more detailed analysis must be conducted to draw any sort of conclusions regarding prediction fairness of the LLM.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[51]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">GROUP_A</span> <span class="o">=</span> <span class="s2">&quot;Asian&quot;</span>
<span class="c1"># GROUP_A = &quot;White&quot;</span>
<span class="n">GROUP_B</span> <span class="o">=</span> <span class="s2">&quot;Black&quot;</span>
<span class="c1"># GROUP_B = &quot;Asian&quot;</span>

<span class="n">COLUMN</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">GROUP_A</span><span class="si">}</span><span class="s2">_v_</span><span class="si">{</span><span class="n">GROUP_B</span><span class="si">}</span><span class="s2">_score_bias&quot;</span>

<span class="n">plot_df</span> <span class="o">=</span> <span class="n">calibration_per_subgroup_df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">results_df</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;1:1&quot;</span><span class="p">)</span>
<span class="n">plot_df</span> <span class="o">=</span> <span class="n">plot_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="n">id_</span> <span class="k">for</span> <span class="n">id_</span> <span class="ow">in</span> <span class="n">plot_df</span><span class="o">.</span><span class="n">index</span> <span class="k">if</span> <span class="s2">&quot;gemma&quot;</span> <span class="ow">in</span> <span class="n">id_</span><span class="o">.</span><span class="n">lower</span><span class="p">()])</span>   <span class="c1"># omit Gemma models bc they&#39;re garbage :)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span>
    <span class="n">data</span><span class="o">=</span><span class="n">plot_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">COLUMN</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">x</span><span class="o">=</span><span class="n">COLUMN</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">,</span>
    <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;is_inst&quot;</span><span class="p">,</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">handles</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">handles</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Base&quot;</span><span class="p">,</span> <span class="s2">&quot;Instruct&quot;</span><span class="p">])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;$\Delta_</span><span class="si">{SCE}</span><span class="s2">$&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
    <span class="s2">&quot;Signed risk score bias</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;($SCE_{&quot;</span> <span class="o">+</span> <span class="n">GROUP_A</span>
    <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;} - SCE_{&quot;</span> <span class="o">+</span> <span class="n">GROUP_B</span>
    <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;}$)&quot;</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>

<span class="n">save_fig</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;score_bias.</span><span class="si">{</span><span class="n">COLUMN</span><span class="si">}</span><span class="s2">.pdf&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Saved figure to &#39;../results/imgs/score_bias.Asian_v_Black_score_bias.numeric-prompt.pdf&#39;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_paper-plots-and-tables_80_1.png" src="../_images/notebooks_paper-plots-and-tables_80_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[52]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">COLUMN</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[52]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>White_score_bias</th>
      <th>Black_score_bias</th>
      <th>Asian_score_bias</th>
      <th>White_v_Black_score_bias</th>
      <th>White_v_Asian_score_bias</th>
      <th>Asian_v_Black_score_bias</th>
      <th>accuracy</th>
      <th>accuracy_diff</th>
      <th>accuracy_ratio</th>
      <th>balanced_accuracy</th>
      <th>...</th>
      <th>name</th>
      <th>is_inst</th>
      <th>num_features</th>
      <th>uses_all_features</th>
      <th>fit_thresh_on_100</th>
      <th>fit_thresh_accuracy</th>
      <th>optimal_thresh</th>
      <th>optimal_thresh_accuracy</th>
      <th>score_stdev</th>
      <th>score_mean</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Mixtral-8x22B-v0.1__ACSIncome__-1__Num</th>
      <td>0.054322</td>
      <td>-0.069436</td>
      <td>0.130153</td>
      <td>0.123758</td>
      <td>-0.075831</td>
      <td>0.199589</td>
      <td>0.740583</td>
      <td>0.148527</td>
      <td>0.828562</td>
      <td>0.761428</td>
      <td>...</td>
      <td>Mixtral 8x22B</td>
      <td>False</td>
      <td>-1.0</td>
      <td>True</td>
      <td>0.65</td>
      <td>0.769300</td>
      <td>0.45</td>
      <td>0.740595</td>
      <td>0.379947</td>
      <td>0.411113</td>
    </tr>
    <tr>
      <th>Mixtral-8x22B-Instruct-v0.1__ACSIncome__-1__Num</th>
      <td>0.110399</td>
      <td>0.055872</td>
      <td>0.156710</td>
      <td>0.054527</td>
      <td>-0.046311</td>
      <td>0.100837</td>
      <td>0.767882</td>
      <td>0.096716</td>
      <td>0.885938</td>
      <td>0.770218</td>
      <td>...</td>
      <td>Mixtral 8x22B (it)</td>
      <td>True</td>
      <td>-1.0</td>
      <td>True</td>
      <td>0.65</td>
      <td>0.769967</td>
      <td>0.55</td>
      <td>0.767882</td>
      <td>0.298323</td>
      <td>0.474955</td>
    </tr>
    <tr>
      <th>penai/gpt-4o-mini__ACSIncome__-1__Num</th>
      <td>-0.001300</td>
      <td>-0.019960</td>
      <td>-0.000407</td>
      <td>0.018661</td>
      <td>-0.000893</td>
      <td>0.019553</td>
      <td>0.777393</td>
      <td>0.080767</td>
      <td>0.904748</td>
      <td>0.758922</td>
      <td>...</td>
      <td>GPT 4o mini (it)</td>
      <td>True</td>
      <td>-1.0</td>
      <td>True</td>
      <td>0.65</td>
      <td>0.777302</td>
      <td>0.35</td>
      <td>0.775512</td>
      <td>0.317359</td>
      <td>0.363743</td>
    </tr>
  </tbody>
</table>
<p>3 rows × 70 columns</p>
</div></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="Plots-comparing-different-prompting-schemes">
<h1>Plots comparing different prompting schemes<a class="headerlink" href="#Plots-comparing-different-prompting-schemes" title="Link to this heading"></a></h1>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[53]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">### Plot all models / i.t. / base?</span>
<span class="n">IT_OR_BASE</span> <span class="o">=</span> <span class="s2">&quot;any&quot;</span>
<span class="c1"># IT_OR_BASE = &quot;it&quot;</span>
<span class="c1"># IT_OR_BASE = &quot;base&quot;</span>

<span class="c1">### Plot which metric</span>
<span class="n">METRIC</span> <span class="o">=</span> <span class="s2">&quot;ece&quot;</span>
<span class="c1"># METRIC = &quot;roc_auc&quot;</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[54]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Prepare data</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">all_results_df_original</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="n">min_max_per_task</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">task</span><span class="p">:</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">values</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">ALL_TASKS</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span> <span class="o">:=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="n">task_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">task</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="n">numeric_prompt_col</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">())][</span><span class="n">METRIC</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span>
<span class="p">}</span>

<span class="c1"># Sort models</span>
<span class="n">sorted_df_index</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
    <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
    <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">id_</span><span class="p">:</span> <span class="n">model_sort_key</span><span class="p">(</span><span class="n">id_</span><span class="p">,</span> <span class="n">df</span><span class="p">),</span>
    <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sorted_df_index</span><span class="p">]</span>

<span class="k">if</span> <span class="n">IT_OR_BASE</span> <span class="o">==</span> <span class="s2">&quot;it&quot;</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Plotting IT models&quot;</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;is_inst&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">]</span>
<span class="k">elif</span> <span class="n">IT_OR_BASE</span> <span class="o">==</span> <span class="s2">&quot;base&quot;</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Plotting BASE models&quot;</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;is_inst&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Plotting ALL models&quot;</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;is_inst&quot;</span><span class="p">,</span> <span class="s2">&quot;model_size&quot;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Data for multiple-choice prompting</span>
<span class="n">df_mult_choice</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">numeric_prompt_col</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">]</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">task_col</span><span class="p">],</span> <span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Data for numeric risk prompting</span>
<span class="n">df_numeric</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">numeric_prompt_col</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">]</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">task_col</span><span class="p">],</span> <span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Sorted list of model names</span>
<span class="n">model_names</span> <span class="o">=</span> <span class="n">df_numeric</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">n_models</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_names</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_names</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Plotting ALL models
model_names=[&#39;Gemma 2B&#39;, &#39;Gemma 7B&#39;, &#39;Mistral 7B&#39;, &#39;Llama 3 8B&#39;, &#39;Yi 34B&#39;, &#39;Mixtral 8x7B&#39;, &#39;Llama 3 70B&#39;, &#39;Mixtral 8x22B&#39;, &#39;Gemma 2B (it)&#39;, &#39;Gemma 7B (it)&#39;, &#39;Mistral 7B (it)&#39;, &#39;Llama 3 8B (it)&#39;, &#39;Yi 34B (it)&#39;, &#39;Mixtral 8x7B (it)&#39;, &#39;Llama 3 70B (it)&#39;, &#39;Mixtral 8x22B (it)&#39;, &#39;GPT 4o mini (it)&#39;]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[55]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.patches</span><span class="w"> </span><span class="kn">import</span> <span class="n">FancyArrowPatch</span>

<span class="c1"># Create a figure and axis</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">ALL_TASKS</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">n_models</span> <span class="o">/</span> <span class="mi">3</span><span class="p">),</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">for</span> <span class="n">task_i</span><span class="p">,</span> <span class="n">task</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ALL_TASKS</span><span class="p">):</span>

    <span class="c1"># Get current plot axis</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">task_i</span><span class="p">]</span>

    <span class="c1"># Plot arrows for each model</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">model_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">model_names</span><span class="p">):</span>

        <span class="n">curr_mult_choice_metric</span> <span class="o">=</span> <span class="n">df_mult_choice</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">model_name</span><span class="p">,</span> <span class="n">task</span><span class="p">][</span><span class="n">METRIC</span><span class="p">]</span>
        <span class="n">curr_numeric_metric</span> <span class="o">=</span> <span class="n">df_numeric</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">model_name</span><span class="p">,</span> <span class="n">task</span><span class="p">][</span><span class="n">METRIC</span><span class="p">]</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
            <span class="n">curr_mult_choice_metric</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="n">palette</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;s&quot;</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Multiple-choice&#39;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
            <span class="n">curr_numeric_metric</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="n">palette</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Numeric&#39;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Draw a FancyArrowPatch arrow from before to after fine-tuning</span>
        <span class="k">if</span> <span class="n">METRIC</span> <span class="o">==</span> <span class="s2">&quot;ece&quot;</span><span class="p">:</span>
            <span class="n">curr_metric_improved</span> <span class="o">=</span> <span class="n">curr_numeric_metric</span> <span class="o">&lt;=</span> <span class="n">curr_mult_choice_metric</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">curr_metric_improved</span> <span class="o">=</span> <span class="n">curr_numeric_metric</span> <span class="o">&gt;=</span> <span class="n">curr_mult_choice_metric</span>

        <span class="n">arrow</span> <span class="o">=</span> <span class="n">FancyArrowPatch</span><span class="p">(</span>
            <span class="p">(</span><span class="n">curr_mult_choice_metric</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span> <span class="p">(</span><span class="n">curr_numeric_metric</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span>
            <span class="n">arrowstyle</span><span class="o">=</span><span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="n">palette</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="n">curr_metric_improved</span> <span class="k">else</span> <span class="n">palette</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
            <span class="n">mutation_scale</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
            <span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">arrow</span><span class="p">)</span>

        <span class="c1"># Set axes ranges according to overall min/max values</span>
        <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span> <span class="o">=</span> <span class="n">min_max_per_task</span><span class="p">[</span><span class="n">task</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">METRIC</span> <span class="o">==</span> <span class="s2">&quot;ece&quot;</span><span class="p">:</span>
            <span class="n">lo</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">lo</span> <span class="o">-</span> <span class="mf">5e-2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">hi</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">hi</span> <span class="o">+</span> <span class="mf">5e-2</span><span class="p">,</span> <span class="mf">0.475</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">METRIC</span> <span class="o">==</span> <span class="s2">&quot;roc_auc&quot;</span><span class="p">:</span>
            <span class="n">lo</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">lo</span> <span class="o">-</span> <span class="mf">5e-2</span><span class="p">,</span> <span class="mf">0.475</span><span class="p">)</span>
            <span class="n">hi</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">hi</span> <span class="o">+</span> <span class="mf">4e-2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">task</span> <span class="o">==</span> <span class="s2">&quot;ACSIncome&quot;</span> <span class="ow">and</span> <span class="n">METRIC</span> <span class="o">==</span> <span class="s2">&quot;roc_auc&quot;</span><span class="p">:</span>
            <span class="n">lo</span> <span class="o">=</span> <span class="mf">0.58</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">)</span>

    <span class="c1"># Set y-ticks and y-labels</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_models</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">model_names</span><span class="p">)</span>

    <span class="c1"># # Prettify x-axis ticks</span>
    <span class="c1"># xticks = ax.get_xticks()</span>
    <span class="c1"># ax.set_xticks(xticks, [f&quot;{x}&quot; for x in xticks])</span>

    <span class="c1"># Add labels and title</span>
    <span class="c1"># ax.set_xlabel(&#39;ECE&#39;)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">task</span><span class="p">[</span><span class="mi">3</span><span class="p">:])</span>

    <span class="c1"># Add horizontal line separating instruct and base models</span>
    <span class="k">if</span> <span class="n">IT_OR_BASE</span> <span class="o">==</span> <span class="s2">&quot;any&quot;</span><span class="p">:</span>
        <span class="n">n_instruct_models</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_mult_choice</span><span class="p">[(</span><span class="n">df_mult_choice</span><span class="p">[</span><span class="s2">&quot;is_inst&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_mult_choice</span><span class="p">[</span><span class="n">task_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">task</span><span class="p">)])</span>
        <span class="n">line_y</span> <span class="o">=</span> <span class="n">n_instruct_models</span> <span class="o">-</span> <span class="mf">1.5</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">line_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#, label=&quot;instruct / base&quot;)</span>

        <span class="c1"># Add text label near the horizontal line</span>
        <span class="k">if</span> <span class="n">task_i</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">ALL_TASKS</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">text_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span>
                <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">get_yaxis_transform</span><span class="p">(),</span>  <span class="c1"># Use axis coordinates for y-axis</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">line_y</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s1">&#39;i.t.&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">text_kwargs</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">line_y</span> <span class="o">-</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s1">&#39;base&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">text_kwargs</span><span class="p">)</span>



<span class="c1"># Add legend for marker</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">),</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Prompting scheme&quot;</span><span class="p">)</span>

<span class="c1"># X-axis label</span>
<span class="k">if</span> <span class="n">METRIC</span> <span class="o">==</span> <span class="s2">&quot;ece&quot;</span><span class="p">:</span>
    <span class="n">x_axis_label</span> <span class="o">=</span> <span class="s2">&quot;Expected Calibration Error (ECE)&quot;</span>
<span class="k">elif</span> <span class="n">METRIC</span> <span class="o">==</span> <span class="s2">&quot;roc_auc&quot;</span><span class="p">:</span>
    <span class="n">x_axis_label</span> <span class="o">=</span> <span class="s2">&quot;Predictive Power (ROC AUC)&quot;</span>

<span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.02</span> <span class="k">if</span> <span class="n">IT_OR_BASE</span> <span class="o">==</span> <span class="s2">&quot;any&quot;</span> <span class="k">else</span> <span class="o">-</span><span class="mf">0.04</span><span class="p">,</span> <span class="n">x_axis_label</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">)</span>

<span class="c1"># Save figure</span>
<span class="n">save_fig</span><span class="p">(</span><span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">METRIC</span><span class="si">}</span><span class="s2">_comparison_diff_prompts.</span><span class="si">{</span><span class="n">IT_OR_BASE</span><span class="si">}</span><span class="s2">-models.pdf&quot;</span><span class="p">,</span> <span class="n">add_prompt_suffix</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Show plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Saved figure to &#39;../results/imgs/ece_comparison_diff_prompts.any-models.pdf&#39;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_paper-plots-and-tables_85_1.png" src="../_images/notebooks_paper-plots-and-tables_85_1.png" />
</div>
</div>
<section id="Scatter-plot-of-ECE-vs-AUC-for-a-few-models-(before-and-after-numeric-prompting)">
<h2>Scatter plot of ECE vs AUC for a few models (before and after numeric prompting)<a class="headerlink" href="#Scatter-plot-of-ECE-vs-AUC-for-a-few-models-(before-and-after-numeric-prompting)" title="Link to this heading"></a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[56]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_METRIC</span> <span class="o">=</span> <span class="s2">&quot;ece&quot;</span>
<span class="n">Y_METRIC</span> <span class="o">=</span> <span class="s2">&quot;roc_auc&quot;</span>

<span class="c1"># Filter out small models</span>
<span class="n">df_mult_choice</span> <span class="o">=</span> <span class="n">df_mult_choice</span><span class="p">[</span><span class="n">df_mult_choice</span><span class="p">[</span><span class="s2">&quot;model_size&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">]</span>
<span class="n">df_numeric</span> <span class="o">=</span> <span class="n">df_numeric</span><span class="p">[</span><span class="n">df_numeric</span><span class="p">[</span><span class="s2">&quot;model_size&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">]</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">ALL_TASKS</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ALL_TASKS</span><span class="p">)</span> <span class="o">*</span> <span class="mf">2.6</span><span class="p">,</span> <span class="mf">2.2</span><span class="p">),</span> <span class="n">gridspec_kw</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.4</span><span class="p">))</span>

<span class="n">unique_model_names</span> <span class="o">=</span> <span class="n">df_mult_choice</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
<span class="n">markers</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">unique_model_names</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span><span class="p">,</span> <span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&gt;&quot;</span><span class="p">]))</span>

<span class="k">for</span> <span class="n">task_i</span><span class="p">,</span> <span class="n">task</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ALL_TASKS</span><span class="p">):</span>

    <span class="c1"># Create a figure and axis</span>
    <span class="c1"># fig, ax = plt.subplots(figsize=(2.5, 2.5))</span>

    <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">task_i</span><span class="p">]</span>

    <span class="c1"># Plot arrows for each model</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">model_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">df_mult_choice</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">unique</span><span class="p">()):</span>

        <span class="c1"># Get data for each plotting scheme</span>
        <span class="n">curr_mult_choice_row</span> <span class="o">=</span> <span class="n">df_mult_choice</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">model_name</span><span class="p">,</span> <span class="n">task</span><span class="p">]</span>
        <span class="n">curr_numeric_row</span> <span class="o">=</span> <span class="n">df_numeric</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">model_name</span><span class="p">,</span> <span class="n">task</span><span class="p">]</span>

        <span class="c1"># Get points to plot</span>
        <span class="n">curr_mult_choice_point</span> <span class="o">=</span> <span class="p">(</span><span class="n">curr_mult_choice_row</span><span class="p">[</span><span class="n">X_METRIC</span><span class="p">],</span> <span class="n">curr_mult_choice_row</span><span class="p">[</span><span class="n">Y_METRIC</span><span class="p">])</span>
        <span class="n">curr_numeric_point</span> <span class="o">=</span> <span class="p">(</span><span class="n">curr_numeric_row</span><span class="p">[</span><span class="n">X_METRIC</span><span class="p">],</span> <span class="n">curr_numeric_row</span><span class="p">[</span><span class="n">Y_METRIC</span><span class="p">])</span>

        <span class="c1"># Plot point for multiple-choice prompting</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
            <span class="o">*</span><span class="n">curr_mult_choice_point</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="n">palette</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="n">markers</span><span class="p">[</span><span class="n">model_name</span><span class="p">],</span>
            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Multiple-choice&#39;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Plot point for numeric-style prompting</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
            <span class="o">*</span><span class="n">curr_numeric_point</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="n">palette</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="n">markers</span><span class="p">[</span><span class="n">model_name</span><span class="p">],</span>
            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Numeric&#39;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">curr_numeric_point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span>  <span class="n">curr_mult_choice_point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">curr_numeric_point</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span>  <span class="n">curr_mult_choice_point</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">arrow_color</span> <span class="o">=</span> <span class="n">palette</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">curr_numeric_point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span>  <span class="n">curr_mult_choice_point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">curr_numeric_point</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="n">curr_mult_choice_point</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">arrow_color</span> <span class="o">=</span> <span class="n">palette</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">arrow_color</span> <span class="o">=</span> <span class="s2">&quot;grey&quot;</span>

        <span class="c1"># Draw a FancyArrowPatch arrow from before to after fine-tuning</span>
        <span class="n">arrow</span> <span class="o">=</span> <span class="n">FancyArrowPatch</span><span class="p">(</span>
            <span class="n">curr_mult_choice_point</span><span class="p">,</span> <span class="n">curr_numeric_point</span><span class="p">,</span>
            <span class="n">arrowstyle</span><span class="o">=</span><span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="n">arrow_color</span><span class="p">,</span>
            <span class="n">mutation_scale</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
            <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">arrow</span><span class="p">)</span>

    <span class="c1">### Plot configs</span>
    <span class="c1"># Add labels and title</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">task</span><span class="p">[</span><span class="mi">3</span><span class="p">:])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;ECE&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">task_i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;AUC&quot;</span><span class="p">)</span>

<span class="c1"># Create custom global legend</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.lines</span><span class="w"> </span><span class="kn">import</span> <span class="n">Line2D</span>

<span class="c1"># Create a global legend for markers (model names)</span>
<span class="n">marker_handles</span> <span class="o">=</span> <span class="p">[</span><span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="n">markers</span><span class="p">[</span><span class="n">model</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">markerfacecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">model</span><span class="p">)</span> <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">unique_model_names</span><span class="p">]</span>

<span class="c1"># Create a global legend for colors (prompting schemes)</span>
<span class="n">color_handles</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">markerfacecolor</span><span class="o">=</span><span class="n">palette</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Multiple-choice&quot;</span><span class="p">),</span>
    <span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">markerfacecolor</span><span class="o">=</span><span class="n">palette</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Numeric&quot;</span><span class="p">)</span>
<span class="p">]</span>

<span class="c1"># Position the legends outside the subplots</span>
<span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">marker_handles</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Models&quot;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.13</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.12</span><span class="p">),</span> <span class="n">ncol</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_model_names</span><span class="p">)))</span>
<span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">color_handles</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Prompting Scheme&quot;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.12</span><span class="p">),</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="c1"># Save figure</span>
<span class="n">save_fig</span><span class="p">(</span><span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;comparison_diff_prompts.</span><span class="si">{</span><span class="n">IT_OR_BASE</span><span class="si">}</span><span class="s2">-models.pdf&quot;</span><span class="p">,</span> <span class="n">add_prompt_suffix</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Saved figure to &#39;../results/imgs/comparison_diff_prompts.any-models.pdf&#39;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_paper-plots-and-tables_87_1.png" src="../_images/notebooks_paper-plots-and-tables_87_1.png" />
</div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="custom-acs-task-example.html" class="btn btn-neutral float-left" title="Run folktexts benchmark with a custom ACS task" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="minimal-example_web-API-model.html" class="btn btn-neutral float-right" title="Evaluate model calibration using folktexts" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Social Foundations of Computation, at MPI-IS.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>